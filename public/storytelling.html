<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storytelling Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .lang-switch{position:fixed;top:16px;left:16px;font-size:14px}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f5f7fa;margin:0;padding:2rem;display:flex;flex-direction:column;align-items:center}
    h1{font-size:1.8rem;margin-bottom:1rem}
    .card{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08);border-radius:12px;padding:1.5rem;max-width:640px;width:100%;box-sizing: border-box;}
    label{display:block;font-weight:600;margin-top:1rem}
    select,input[type=text],textarea{width:100%;padding:.6rem .8rem;font-size:1rem;border:1px solid #ccc;border-radius:6px;margin-top:.4rem;box-sizing:border-box}
    textarea{resize:vertical;height:120px}
    button{margin-top:1.5rem;padding:.75rem 1.2rem;font-size:1rem;font-weight:600;border:none;border-radius:8px;cursor:pointer;background:#0077ff;color:#fff;transition:background .2s}
    button:hover{background:#005fce}
    button:disabled{background:#a0a0a0;cursor:not-allowed;}
    #output{margin-top:2rem;background:#fff;border:1px solid #d0d7de;border-radius:10px;padding:1rem 1.5rem;line-height:1.6;font-size:1.05rem;max-width:640px;width: 100%; min-height: 100px; max-height:500px;overflow-y:auto;box-shadow:0 2px 6px rgba(0,0,0,.05);box-sizing: border-box;}
    #output h3{margin:1em 0 .6em;font-size:1.2rem}
    #output blockquote{margin:0 0 1em;padding-left:1em;border-left:4px solid #0077ff;background:#f0f6ff}
    #output ul{padding-left:1.2em}
  </style>
</head>
<body>
  <h1>ü™Ñ Storytelling Generator</h1>

  <!-- Top-left language switch -->
  <div class="lang-switch">
    üåê <select id="uiLang">
      <option value="en">English</option>
      <option value="zh">‰∏≠Êñá</option>
      <option value="zh-Hant">ÁπÅÈ´î</option>
    </select>
  </div>

  <div class="card">
    <label for="purpose"><span class="lbl">Purpose</span>
      <select id="purpose">
        <option value="academic">Academic</option>
        <option value="leisure">Leisure</option>
      </select>
    </label>

    <label for="topic"><span class="lbl">Topic</span>
      <input id="topic" type="text" placeholder="e.g. Space Exploration" />
    </label>

    <label for="grade"><span class="lbl">Grade</span>
      <input id="grade" type="text" placeholder="e.g. 3" />
    </label>

    <label for="duration"><span class="lbl">Duration (minutes)</span>
      <input id="duration" type="text" placeholder="e.g. 10" />
    </label>

    <label for="language"><span class="lbl">Story language</span>
      <select id="language">
        <option value="English">English</option>
        <option value="Chinese">Chinese</option>
        <option value="chi_tra">ÁπÅÈ´î‰∏≠Êñá</option>
      </select>
    </label>

    <label for="details"><span class="lbl">Prompt details</span><br><small style="font-weight:400">(characters, setting, tone‚Ä¶)</small>
      <textarea id="details" placeholder="Two siblings on Mars, friendly robot companion‚Ä¶"></textarea>
    </label>

    <button id="generateBtn">Generate</button>
  </div>

  <div id="output">üìù The story will appear here.</div>

  <script>
    /* ===== I18n Dictionary ===== */
    const i18n = {
      en:{purpose:'Purpose',topic:'Topic',grade:'Grade',duration:'Duration (minutes)',language:'Story language',details:'Prompt details',
          generate:'Generate',placeholderDetails :'Specify: difficulty, number of problems, target skill‚Ä¶',
          storyHere:'üìù The story will appear here.', academicLabel: 'Academic', leisureLabel : 'Leisure', placeholderTopic: 'e.g. Multiplication practice',
          generating: '‚è≥ Generating story‚Ä¶', requiredError: 'Topic, Grade, and Duration are required.'},
      zh:{purpose:'ÁõÆÁöÑ',topic:'‰∏ªÈ¢ò',grade:'Âπ¥Á∫ß',duration:'Êó∂ÈïøÔºàÂàÜÈíüÔºâ',language:'ÁîüÊàêËØ≠Ë®Ä',details:'ÊèêÁ§∫ÁªÜËäÇ',
          generate:'ÁîüÊàê',placeholderTopic:'‰æãÂ¶ÇÔºöÊàêËØ≠ÊïÖ‰∫ãÔºöÁãêÂÅáËôéÂ®Å',placeholderDetails:'ËØ∑ËØ¥ÊòéÔºöÈöæÂ∫¶„ÄÅÈ¢òÁõÆÊï∞Èáè„ÄÅÊïôÂ≠¶ÁõÆÊ†á‚Ä¶',
          storyHere:'üìù ÁîüÊàêÁöÑÊïÖ‰∫ãÂ∞ÜÊòæÁ§∫Âú®Ê≠§', academicLabel: 'Â≠¶ÊúØ', leisureLabel : '‰ºëÈó≤',
          generating: '‚è≥ Ê≠£Âú®ÁîüÊàêÊïÖ‰∫ã‚Ä¶', requiredError: '‰∏ªÈ¢ò„ÄÅÂπ¥Á∫ßÂíåÊó∂Èïø‰∏∫ÂøÖÂ°´È°π„ÄÇ'},
      'zh-Hant':{purpose:'ÁõÆÁöÑ',topic:'‰∏ªÈ°å',grade:'Âπ¥Á¥ö',duration:'ÊôÇÈï∑ÔºàÂàÜÈêòÔºâ',language:'ÁîüÊàêË™ûË®Ä',details:'ÊèêÁ§∫Á¥∞ÁØÄ',
          generate:'ÁîüÊàê',placeholderTopic: '‰æãÂ¶ÇÔºöÊàêË™ûÊïÖ‰∫ãÔºöÁãêÂÅáËôéÂ®Å',placeholderDetails:'Ë´ãË™™ÊòéÔºöÈõ£Â∫¶„ÄÅÈ°åÁõÆÊï∏Èáè„ÄÅÊïôÂ≠∏ÁõÆÊ®ô‚Ä¶',
          storyHere:'üìù ÁîüÊàêÁöÑÊïÖ‰∫ãÂ∞áÈ°ØÁ§∫Âú®Ê≠§', academicLabel: 'Â≠∏Ë°ì',leisureLabel : '‰ºëÈñí',
          generating: '‚è≥ Ê≠£Âú®ÁîüÊàêÊïÖ‰∫ã‚Ä¶', requiredError: '‰∏ªÈ°å„ÄÅÂπ¥Á¥öÂíåÊôÇÈï∑ÁÇ∫ÂøÖÂ°´È†Ö„ÄÇ'}
    };

    /* ===== Apply UI Text based on language ===== */
    function applyUI(lang){
      const t=i18n[lang]||i18n.en;
      const labelsMap={purpose:t.purpose,topic:t.topic,grade:t.grade,duration:t.duration,language:t.language,details:t.details};
      for(const id in labelsMap){
        const span=document.querySelector(`label[for="${id}"] .lbl`);
        if(span) span.textContent=labelsMap[id];
      }
      document.getElementById('topic').placeholder=t.placeholderTopic;
      document.getElementById('details').placeholder=t.placeholderDetails;
      document.getElementById('generateBtn').textContent=t.generate;
      const output = document.getElementById('output');
      if (output.innerHTML.includes('üìù')) {
           output.innerHTML=t.storyHere;
      }
      document.querySelector('#purpose option[value="academic"]').textContent = t.academicLabel;
      document.querySelector('#purpose option[value="leisure"]').textContent = t.leisureLabel;
    }

    /**
     * Calls the backend streaming endpoint and updates the UI in real-time.
     * @param {object} payload - The complete payload to send to the backend.
     * @param {HTMLElement} outputElement - The element to render the story into.
     * @param {HTMLElement} buttonElement - The button that triggered the generation.
     */
    async function callStreamingAPI(payload, outputElement, buttonElement) {
      buttonElement.disabled = true;

      try {
        // *** MODIFIED: Use the new, specific endpoint for story generation ***
        const response = await fetch('https://backend.canpaniongroup.com/aigc/generate-story', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload), // Send the full payload object
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let accumulatedContent = '';
        outputElement.innerHTML = ''; // Clear previous content

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n\n');

          for (const line of lines) {
            if (!line) continue;
            if (line.startsWith('data: ')) {
              const dataString = line.substring(6);
              try {
                const jsonData = JSON.parse(dataString);
                if (jsonData.content) {
                  accumulatedContent += jsonData.content;
                  outputElement.innerHTML = marked.parse(accumulatedContent);
                  outputElement.scrollTop = outputElement.scrollHeight;
                }
              } catch (e) {
                console.error("Failed to parse JSON from stream chunk:", e, "Chunk was:", dataString);
              }
            }
          }
        }
      } catch (err) {
        outputElement.textContent = `An error occurred: ${err.message}`;
        console.error(err);
      } finally {
        buttonElement.disabled = false;
      }
    }

    /* ===== Generate Button Logic ===== */
    document.getElementById('generateBtn').addEventListener('click', async () => {
      const uiLang = document.getElementById('uiLang').value;
      const t = i18n[uiLang] || i18n.en;
      
      // *** MODIFIED: Get Teacher ID (tid). You must make this available in the global scope. ***
      // For example, your Webflow project could set `window.currentTeacher = { tid: '...' };`
      const tid = typeof window !== 'undefined' && window.currentTeacher?.tid ? window.currentTeacher.tid : "TEACHER_UNKNOWN";
      if(tid === "TEACHER_UNKNOWN"){
          console.warn("Warning: Teacher ID (tid) is not set. The story will not be saved to history.");
      }

      // *** MODIFIED: Assemble an 'inputs' object instead of a prompt string. ***
      const inputs = {
          purpose: document.getElementById('purpose').value,
          topic: document.getElementById('topic').value.trim(),
          grade: document.getElementById('grade').value.trim(),
          duration: document.getElementById('duration').value.trim(),
          storyLanguage: document.getElementById('language').value,
          details: document.getElementById('details').value.trim()
      };

      if (!inputs.topic || !inputs.grade || !inputs.duration) {
        alert(t.requiredError);
        return;
      }
      
      // *** MODIFIED: Create the full payload for the new endpoint. ***
      const payload = {
          tid,
          uiLang,
          inputs
      };

      const outputDiv = document.getElementById('output');
      const generateButton = document.getElementById('generateBtn');
      outputDiv.textContent = t.generating;

      await callStreamingAPI(payload, outputDiv, generateButton);
    });

    /* ===== Initialize and listen for UI language switch ===== */
    document.addEventListener('DOMContentLoaded', () => {
      window.currentTeacher=JSON.parse(localStorage.getItem('userInfo'));
      const langSelect = document.getElementById('uiLang');
      applyUI(langSelect.value); // Initial render
      langSelect.addEventListener('change', e => applyUI(e.target.value));
    });
  </script>
</body>
</html>
