<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher All in One AI Chat</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
  <script src="books.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .message {
      display: flex;
      align-items: flex-end;
      margin: 8px 0;
      width: fit-content;
      max-width: 90%;
    }
    .bot {
      flex-direction: row;
    }
    .user {
      flex-direction: row-reverse;
      align-self: flex-end;
    }
    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      animation: fadeIn 0.3s ease-in;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 16px;
      display: inline-block;
      background-color: #eeeeee;
    }
    .user .bubble {
      background-color: #d2f0ff;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin: 0 8px;
    }
    #input-area {
      display: flex;
      flex-direction: column;
      padding: 10px;
      background: white;
      border-top: 1px solid #ccc;
    }
    .input-top-files {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }
    .file-item {
      display: flex;
      align-items: center;
      background: #f0f0f0;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 6px;
      gap: 10px;
    }
    .file-item span {
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-note {
      flex: 1;
      padding: 4px 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .file-item button {
      background: none;
      border: none;
      color: red;
      font-size: 16px;
      cursor: pointer;
    }
    .input-wrapper {
      display: flex;
      align-items: center;
    }
    #user-input {
      flex: 1;
      min-height: 44px;
      max-height: 300px;
      resize: vertical;
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #file-upload {
      display: none;
    }
    .tooltip-wrapper {
      position: relative;
      display: inline-block;
    }
    #file-button {
      background-color: white;
      border: none;
      font-size: 20px;
      margin: 0 10px;
      cursor: pointer;
    }
    .tooltip-text {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
    }
    .tooltip-wrapper:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    .next-button {
      padding: 10px 20px;
      background-color: #10a37f;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
    h2.centered-heading {
      font-size: 28px;
      margin-bottom: 20px;
      text-align: center;
      width: 100%;
    }
    .select-inline {
      margin-left: 12px;
      margin-top: 4px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      padding: 6px;
      border-radius: 6px;
      width: fit-content;
      max-width: 400px;
    }
    .uploaded-file {
      color: rgb(41, 96, 198);
      text-decoration: underline;
      cursor: pointer;
    }
    .uploaded-file:hover {
      text-decoration: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes blink {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    .dot-anim {
      font-size: 20px;
      color: #999;
      animation: blink 1.5s infinite;
      margin: 0 2px;
    }
    button.selected {
      background: #10a37f !important; /* green */
      border-color: #0d8c6d;
      color: white !important;
    }

     .book-item {
    padding: 6px 10px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
  }
  .book-item:hover {
    background: #f7f7f7;
  }
  .book-item.selected {
    background: #d2f0ff;
  }
  .group-title {
    margin: 10px 0 4px;
    font-weight: bold;
    background: #f0f0f0;
    padding: 4px 6px;
  }

  .choice-btn {
    padding: 10px 20px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s ease;
    min-width: 120px;
  }

  .choice-btn:hover {
    background: #f0f0f0;
  }

  .choice-btn.selected {
    background: #10a37f !important;
    color: white !important;
    border-color: #0d8c6d;
  }

  #stage-3 {
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin: 10px 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  #upload-section {
    margin-top: 16px;
    padding: 20px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    text-align: center;
  }

  #db-browser-container {
    margin-top: 16px;
    padding: 16px;
    border: 1px solid #eee;
    border-radius: 8px;
  }

  .source-choice {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    justify-content: center;
  }

  #pdf-preview {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  #pdf-container {
    background: #f5f5f5;
    overflow: auto;
  }

  #confirm-selection {
    width: 100%;
    margin-top: 10px;
    font-weight: 500;
  }

  #confirm-selection:hover {
    background: #0d8c6d !important;
  }

  </style>
</head>
<select id="ocr-lang" style="margin-left: 12px; font-size: 14px; padding: 4px 8px; border-radius: 6px;">
  <option value="eng">English</option>
  <option value="chi_sim">ÁÆÄ‰Ωì‰∏≠Êñá</option>
  <option value="chi_tra">ÁπÅÈ´î‰∏≠Êñá</option>
</select>
<body>
  <div id="chat">
    <h2 class="centered-heading">üëã What do you wanna generate?</h2>
  </div>
  <div id="input-area">
    <div id="file-preview" class="input-top-files"></div>
    <div class="input-wrapper">
      <textarea id="user-input" rows="2"></textarea>
      <div class="tooltip-wrapper">
        <button id="file-button" onclick="document.getElementById('file-upload').click()">Ôºã</button>
        <span class="tooltip-text">Upload File</span>
      </div>
      <input type="file" id="file-upload" multiple />
      <button class="next-button" onclick="handleUserInput()">Next</button>
    </div>
  </div>

  <div id="stage-3" style="display: none;">
    <h3 id="question3-title"></h3>
    
    <div class="source-choice" style="display: flex; gap: 12px; margin-bottom: 16px;">
      <button class="choice-btn" onclick="showUploadSection()">Upload Files</button>
      <button class="choice-btn" onclick="showDatabaseSection()">Browse Database</button>
    </div>

    <div id="upload-section" style="display: none;">
      <input type="file" id="user-upload" accept=".pdf,.doc,.docx" multiple />
    </div>

    <div id="db-browser-container" style="display: none;">
      <strong id="db-browser-label"></strong>
      <input type="text" id="filter-input" placeholder="üîç Search‚Ä¶" style="width:100%; padding:4px; margin:6px 0;" />
      <div id="item-list" style="max-height: 300px; overflow-y:auto; border: 1px solid #eee; padding: 4px;"></div>
      
      <!-- Add PDF preview section -->
      <div id="pdf-preview" style="display: none; margin-top: 20px;">
        <h4 style="margin-bottom: 10px;">Selected File Preview:</h4>
        <div id="pdf-container" style="width: 100%; height: 500px; border: 1px solid #eee; margin-bottom: 10px;"></div>
        <button id="confirm-selection" class="choice-btn" style="background: #10a37f; color: white;">Confirm Selection</button>
      </div>
    </div>
  </div>

  <script>
    // First, let's fix the translations object
    const translations = {
      eng: {
        title: "üëã What do you wanna generate?",
        next: "Next",
        upload: "Upload File",
        yes: "Yes",
        no: "No",
        saveBtn: "Save",
        regenerateBtn: "üîç Regenerate with More Detail",
        morePrompt: "Question 4/5: ‚úèÔ∏è  Add more details: Comment, Grade, Number of Students, Duration, Length",
        refineWhich: "üß© Which part(s) would you like to be more specific?",
        done: "üéâ Got it! Let me know if you need anything else.",
        question1: "Question 1/5: üëá Please select a type:",
        question2: "Question 2/5: üí≠ Why do you need this?",
        question3: "Question 3/5: üìé What do you have on hand?",
        question4: "Question 4/5: ‚úèÔ∏è Add more details",
        question5: "Question 5/5: üîç Do you want to make any part more specific?",
        pleaseFill: "Please fill in at least one field.",
        noExtractedText: "No extracted text found ‚Äì please upload a PDF / Word / image first.",
        noTemplateFound: "‚ö†Ô∏è No corresponding template was found to generate content!",
        atLeastOnePart: "Please select at least one part to refine.",
        generationFailed: "‚ùå Generation failed. Please try again.",
        pleaseRefine: "‚úÖ Yes, please refine.",
        noThanks: "‚ùå No, that's enough.",
        replacedMsg: "üîÑ \"{filename}\" replaced.",
        replaceConfirm: "Replace previously uploaded \"{filename}\"?",
        infoCollected: "‚úÖ All info collected. Ready to generate!",
        type_lesson: "Lesson Plan",
        type_materials: "Class Materials (PPT/pictures)",
        type_report: "Report Card",
        type_feedback: "Student‚ÄëWork Feedback",
        type_bank: "Subject Question Bank / Assignment",
        type_activity: "Activity Plan / Extracurricular",
        type_admin: "Admin Helper (PPT / Word)",
        ph_comment: "Comment (optional)",
        ph_grade: "Grade (optional)",
        ph_students: "Number of Students",
        ph_duration: "Duration (e.g., 45 mins)",
        ph_length: "Length (Short / Medium / Long)",
        pleaseWait: "Please wait for 1 minute‚Ä¶",
        ph_input: "Type something...",
        details: "Details",
        label_comment: "Comment",
        label_grade: "Grade",
        label_students: "Number of Students",
        label_duration: "Duration",
        label_length: "Length",
        na: "N/A",
        browseFiles: "üìÅ Browse files from database:",
        uploadFiles: "Upload Files",
        browseDatabase: "Browse Database",
        confirmSelection: "Confirm Selection"
      }
    };

    // Add Chinese translations
    translations.chi_sim = Object.assign({}, translations.eng, {
      title: "üëã ‰Ω†ÊÉ≥ÁîüÊàê‰ªÄ‰πàÔºü",
      next: "‰∏ã‰∏ÄÊ≠•",
      upload: "‰∏ä‰º†Êñá‰ª∂",
      yes: "ÊòØ",
      no: "Âê¶",
      uploadFiles: "‰∏ä‰º†Êñá‰ª∂",
      browseDatabase: "ÊµèËßàÊï∞ÊçÆÂ∫ì",
      browseFiles: "üìÅ ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠ÈÄâÊã©Êñá‰ª∂Ôºö",
      confirmSelection: "Á°ÆËÆ§ÈÄâÊã©"
    });

    translations.chi_tra = Object.assign({}, translations.eng, {
      title: "üëã ‰Ω†ÊÉ≥Ë¶ÅÁîüÊàê‰ªÄÈ∫ºÔºü",
      next: "‰∏ã‰∏ÄÊ≠•",
      upload: "‰∏äÂÇ≥Ê™îÊ°à",
      yes: "ÊòØ",
      no: "Âê¶",
      uploadFiles: "‰∏äÂÇ≥Ê™îÊ°à",
      browseDatabase: "ÁÄèË¶ΩÊï∏ÊìöÂ∫´",
      browseFiles: "üìÅ ÂæûÊï∏ÊìöÂ∫´‰∏≠ÈÅ∏ÊìáÊñá‰ª∂Ôºö",
      confirmSelection: "Á¢∫Ë™çÈÅ∏Êìá"
    });

    const chat = document.getElementById('chat');
    const input = document.getElementById('user-input');
    const fileInput = document.getElementById('file-upload');
    const filePreview = document.getElementById('file-preview');
    let fullMarkdown = ''; 
    const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const templateSections = {
      "Lesson Plan": {
        eng: [
          "Lesson Title / Subject Area",
          "Learning Goals & Measurable Objectives",
          "Prerequisite Knowledge",
          "Materials / Resources List",
          "Step‚Äëby‚Äëstep Procedure & Timing",
          "Assessment / Evidence of Learning",
          "Differentiation / Accommodations",
          "Anticipated Difficulties/ Challenges ‚Üí Solution",
          "Follow‚Äëup / Reflection box"
        ],
        chi_sim: [
          "ËØæÈ¢ò / Â≠¶ÁßëÈ¢ÜÂüü",
          "Â≠¶‰π†ÁõÆÊ†á & ÂèØÊµãÈáèÊåáÊ†á",
          "ÂÖàÂ§áÁü•ËØÜ",
          "ÊùêÊñô / ËµÑÊ∫êÊ∏ÖÂçï",
          "ËØæÂ†ÇÊ≠•È™§ & Êó∂Èó¥ÂàÜÈÖç",
          "ËØÑ‰º∞ÊñπÂºè / Â≠¶‰π†ËØÅÊçÆ",
          "Â∑ÆÂºÇÂåñÊïôÂ≠¶ / ÈÄÇÂ∫îÁ≠ñÁï•",
          "È¢ÑÂà§ÈöæÁÇπ / ÊåëÊàò ‚Üí Ëß£ÂÜ≥ÊñπÊ°à",
          "ËØæÂêéË∑üËøõ / ÂèçÊÄù"
        ],
        chi_tra: [
          "Ë™≤Á®ãÊ®ôÈ°å / ÁßëÁõÆÈ†òÂüü",
          "Â≠∏ÁøíÁõÆÊ®ô & ÂèØË°°ÈáèÊåáÊ®ô",
          "ÂÖàÂÇôÁü•Ë≠ò",
          "ÊùêÊñô / Ë≥áÊ∫êÊ∏ÖÂñÆ",
          "Ê≠•È©üÊµÅÁ®ã & ÊôÇÈñìÈÖçÁΩÆ",
          "Ë©ïÈáèÊñπÂºè / Â≠∏ÁøíË≠âÊìö",
          "Â∑ÆÁï∞ÂåñÊïôÂ≠∏ / Ë™øÊï¥ÊñπÊ°à",
          "È†êÊúüÂõ∞Èõ£ / ÊåëÊà∞ ‚Üí Ëß£Ê±∫Á≠ñÁï•",
          "ÂæåÁ∫åËøΩËπ§ / ÂèçÊÄù"
        ]
      },
      "Class Materials (PPT/pictures)": {
        eng: [
          "Presentation Topic / Focus Question",
          "Expected Audience (Grade or Course)",
          "Key Points / Slide Outline",
          "Desired Visual Assets (images, charts, video links)",
          "Desired Audio Assets (music, sound clips)",
          "Branding Elements (school logo, colors, fonts)",
          "Speaker‚Äënote Depth (none / bullet / full script)"
        ],
        chi_sim: [
          "ÊºîÁ§∫‰∏ªÈ¢ò / ÂÖ≥Ê≥®ÈóÆÈ¢ò",
          "ÁõÆÊ†áÂèó‰ºóÔºàÂπ¥Á∫ßÊàñËØæÁ®ãÔºâ",
          "ÂÖ≥ÈîÆË¶ÅÁÇπ / ÂπªÁÅØÁâáÂ§ßÁ∫≤",
          "ËßÜËßâÁ¥†ÊùêÈúÄÊ±ÇÔºàÂõæÁâá„ÄÅÂõæË°®„ÄÅËßÜÈ¢ëÈìæÊé•Ôºâ",
          "Èü≥È¢ëÁ¥†ÊùêÈúÄÊ±ÇÔºàÈü≥‰πê„ÄÅÈü≥ÊïàÔºâ",
          "ÂìÅÁâåÂÖÉÁ¥†ÔºàÊ†°ÂæΩ„ÄÅËâ≤ÂΩ©„ÄÅÂ≠ó‰ΩìÔºâ",
          "ÊºîËÆ≤ËÄÖÂ§áÊ≥®Ê∑±Â∫¶ÔºàÊó† / Ë¶ÅÁÇπ / ÂÖ®ËÑöÊú¨Ôºâ"
        ],
        chi_tra: [
          "Á∞°Â†±‰∏ªÈ°å / ÁÑ¶ÈªûÂïèÈ°å",
          "È†êÊúüÂèóÁúæÔºàÂπ¥Á¥öÊàñË™≤Á®ãÔºâ",
          "ÈáçÈªû / ÊäïÂΩ±ÁâáÂ§ßÁ∂±",
          "Ë¶ñË¶∫Á¥†ÊùêÈúÄÊ±ÇÔºàÂúñÁâá„ÄÅÂúñË°®„ÄÅÂΩ±ÁâáÈèàÊé•Ôºâ",
          "Èü≥Ë®äÁ¥†ÊùêÈúÄÊ±ÇÔºàÈü≥Ê®Ç„ÄÅÈü≥ÊïàÔºâ",
          "ÂìÅÁâåÂÖÉÁ¥†ÔºàÊ†°ÂæΩ„ÄÅËâ≤ÂΩ©„ÄÅÂ≠óÈ´îÔºâ",
          "Ë¨õËÄÖÂÇôË®ªÊ∑±Â∫¶ÔºàÁÑ° / Ë¶ÅÈªû / ÂÆåÊï¥Á®øÔºâ"
        ]
      },
      "Report Card": {
        eng: [
          "Student & Class Identifiers",
          "Term / Grading Period",
          "Subject List & Grade Scale",
          "Attendance Figures",
          "Behavior /Work‚ÄëHabit Ratings",
          "Other Learning Experience/ Extra-curricular activities",
          "Award",
          "Teacher Narrative Comments",
          "Parent signature flag"
        ],
        chi_sim: [
          "Â≠¶Áîü‰∏éÁè≠Á∫ß‰ø°ÊÅØ",
          "Â≠¶Êúü / ÊàêÁª©Âë®Êúü",
          "ÁßëÁõÆÂàóË°®‰∏éËØÑÂàÜÊ†áÂáÜ",
          "Âá∫Âã§Êï∞ÊçÆ",
          "Ë°å‰∏∫ / Â≠¶‰π†‰π†ÊÉØËØÑÂàÜ",
          "ÂÖ∂‰ªñÂ≠¶‰π†ÁªèÂéÜ / ËØæÂ§ñÊ¥ªÂä®",
          "Â•ñÂä±",
          "ÊïôÂ∏àËØÑËØ≠",
          "ÂÆ∂ÈïøÁ≠æÂêçÈ°π"
        ],
        chi_tra: [
          "Â≠∏ÁîüËàáÁè≠Á¥öË≥áË®ä",
          "Â≠∏Êúü / ÊàêÁ∏æÈÄ±Êúü",
          "ÁßëÁõÆÊ∏ÖÂñÆËàáË©ïÂàÜÊ®ôÊ∫ñ",
          "Âá∫Âã§Êï∏Êìö",
          "Ë°åÁÇ∫ / Â≠∏ÁøíÁøíÊÖ£Ë©ïÂàÜ",
          "ÂÖ∂‰ªñÂ≠∏ÁøíÁ∂ìÈ©ó / Ë™≤Â§ñÊ¥ªÂãï",
          "ÁçéÂãµ",
          "ÊïôÂ∏´Ë©ïË™û",
          "ÂÆ∂Èï∑Á∞ΩÂêçÈ†Ö"
        ]
      },

      "Student-Work Feedback": {
        eng: [
          "Student / Assignment ID",
          "Rubric criteria or \"Glow & Grow\" fields (Strengths, Needs, Next Steps)",
          "Performance level or score",
          "Inline examples / Quotes",
          "Overall Comment",
          "Next-check-in Date"
        ],
        chi_sim: [
          "Â≠¶Áîü / ‰Ωú‰∏öÁºñÂè∑",
          "ËØÑÂàÜÊ†áÂáÜÊàñ‰ºòÁÇπ‰∏éÊîπËøõÂ≠óÊÆµÔºà‰ºòÂäø„ÄÅÈúÄÊîπËøõ„ÄÅ‰∏ã‰∏ÄÊ≠•Ôºâ",
          "Ë°®Áé∞Á≠âÁ∫ßÊàñÂàÜÊï∞",
          "Êñá‰∏≠Á§∫‰æã / ÂºïËØ≠",
          "Êï¥‰ΩìËØÑËØ≠",
          "‰∏ãÊ¨°ÂõûÈ°æÊó•Êúü"
        ],
        chi_tra: [
          "Â≠∏Áîü / ‰ΩúÊ•≠Á∑®Ëôü",
          "Ë©ïÂàÜÊ®ôÊ∫ñÊàñ„Äå‰∫ÆÈªûËàáÊîπÈÄ≤„ÄçÊ¨Ñ‰ΩçÔºàÂÑ™Âã¢„ÄÅÈúÄÊîπÂñÑ„ÄÅÂæåÁ∫åÊ≠•È©üÔºâ",
          "Ë°®ÁèæÁ≠âÁ¥öÊàñÂàÜÊï∏",
          "ÂÖßÊñáÁ§∫‰æã / ÂºïË™û",
          "Êï¥È´îË©ïË´ñ",
          "‰∏ãÊ¨°Ê™¢Ë¶ñÊó•Êúü"
        ]
      },

      "Subject Question Bank / Assignment": {
        eng: [
          "Subject & Topic Tags",
          "Standard Alignment",
          "Question Type (MCQ, open, etc.)",
          "Difficulty Level",
          "Question Text",
          "Answer Choices & Correct Answer",
          "Explanation / Feedback",
          "Time Limit Per Item",
          "Category Folder"
        ],
        chi_sim: [
          "Â≠¶Áßë‰∏é‰∏ªÈ¢òÊ†áÁ≠æ",
          "ËØæÁ®ãÊ†áÂáÜÂØπÈΩê",
          "È¢òÂûãÔºàÈÄâÊã©È¢ò„ÄÅÂºÄÊîæÈ¢òÁ≠âÔºâ",
          "ÈöæÂ∫¶Á≠âÁ∫ß",
          "È¢òÂπ≤",
          "ÈÄâÈ°π‰∏éÊ≠£Á°ÆÁ≠îÊ°à",
          "Ëß£Êûê / ÂèçÈ¶à",
          "ÊØèÈ¢òÊó∂Èó¥ÈôêÂà∂",
          "ÂàÜÁ±ªÊñá‰ª∂Â§π"
        ],
        chi_tra: [
          "Â≠∏ÁßëËàá‰∏ªÈ°åÊ®ôÁ±§",
          "Ë™≤Á∂±Â∞çÊáâ",
          "È°åÂûãÔºàÈÅ∏ÊìáÈ°å„ÄÅÈñãÊîæÈ°åÁ≠âÔºâ",
          "Èõ£Â∫¶Á≠âÁ¥ö",
          "È°åÁõÆÂÖßÂÆπ",
          "ÈÅ∏È†ÖËàáÊ≠£Á¢∫Á≠îÊ°à",
          "Ëß£Êûê / ÂõûÈ•ã",
          "ÊØèÈ°åÊôÇÈñìÈôêÂà∂",
          "ÂàÜÈ°ûË≥áÊñôÂ§æ"
        ]
      },

      "Activity Plan / Extracurricular": {
        eng: [
          "Activity Name & Purpose",
          "Date(s) / Time block",
          "Location & Access notes",
          "Target Group / # Students",
          "Required materials & Equipment",
          "Action plan",
          "Roles & supervision: resources allocation/ responsibilities",
          "Risk / safety considerations",
          "Assessment or reflection Method"
        ],
        chi_sim: [
          "Ê¥ªÂä®ÂêçÁß∞‰∏éÁõÆÁöÑ",
          "Êó•Êúü / Êó∂Èó¥ÊÆµ",
          "Âú∞ÁÇπ‰∏éËøõÂÖ•ËØ¥Êòé",
          "ÁõÆÊ†áÁæ§‰Ωì / Â≠¶Áîü‰∫∫Êï∞",
          "ÊâÄÈúÄÊùêÊñô‰∏éËÆæÂ§á",
          "Ë°åÂä®ËÆ°Âàí",
          "ËÅåË¥£‰∏éÁõëÁù£ÔºöËµÑÊ∫êÈÖçÁΩÆ / ÂàÜÂ∑•",
          "È£éÈô© / ÂÆâÂÖ®ËÄÉÈáè",
          "ËØÑ‰º∞ÊàñÂèçÊÄùÊñπÂºè"
        ],
        chi_tra: [
          "Ê¥ªÂãïÂêçÁ®±ËàáÁõÆÁöÑ",
          "Êó•Êúü / ÊôÇÊÆµ",
          "Âú∞ÈªûËàáÈÄ≤Âá∫Ë™™Êòé",
          "ÁõÆÊ®ôÂ∞çË±° / Â≠∏Áîü‰∫∫Êï∏",
          "ÊâÄÈúÄÊùêÊñôËàáË®≠ÂÇô",
          "Ë°åÂãïË®àÁï´",
          "ËÅ∑Ë≤¨ËàáÁõ£Áù£ÔºöË≥áÊ∫êÂàÜÈÖç / ‰ªªÂãôÂàÜÂ∑•",
          "È¢®Èö™ / ÂÆâÂÖ®ËÄÉÈáè",
          "Ë©ï‰º∞ÊàñÂèçÊÄùÊñπÂºè"
        ]
      },

      "Admin Helper (PPT / Word)": {
        eng: [
          "Document Type (agenda, newsletter, handbook, policy)",
          "Audience",
          "Key Sections / Talking Points",
          "Attachments / Links",
          "Header-footer Branding",
          "Distribution Date"
        ],
        chi_sim: [
          "ÊñáÊ°£Á±ªÂûãÔºàËÆÆÁ®ã„ÄÅÁÆÄÊä•„ÄÅÊâãÂÜå„ÄÅÊîøÁ≠ñÁ≠âÔºâ",
          "ÁõÆÊ†áËØªËÄÖ",
          "ÈáçÁÇπÈÉ®ÂàÜ / Ë¶ÅÁÇπ",
          "ÈôÑ‰ª∂ / ÈìæÊé•",
          "È°µÁúâÈ°µËÑöÂìÅÁâåÊ†áËØÜ",
          "ÂèëÂ∏ÉÊó•Êúü"
        ],
        chi_tra: [
          "Êñá‰ª∂È°ûÂûãÔºàË≠∞Á®ã„ÄÅÁ∞°Â†±„ÄÅÊâãÂÜä„ÄÅÊîøÁ≠ñÁ≠âÔºâ",
          "ÁõÆÊ®ôËÆÄËÄÖ",
          "ÈáçÈªûÂÖßÂÆπ / Ë®éË´ñË¶ÅÈªû",
          "ÈôÑ‰ª∂ / ÈèàÁµê",
          "È†ÅÈ¶ñÈ†ÅÂ∞æÂìÅÁâåÊ®ôË™å",
          "ÁôºÂ∏ÉÊó•Êúü"
        ]
      }
    };
    const topicTemplates = {
      "Lesson Plan": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩÂÖ∑‰ΩìÁöÑ Lesson PlanÔºö
    ‚Ä¢ Lesson Title / Subject Area
    ‚Ä¢ Learning Goals & Measurable Objectives
    ‚Ä¢ Prerequisite Knowledge
    ‚Ä¢ Materials / Resources List
    ‚Ä¢ Step‚Äëby‚Äëstep Procedure & Timing
    ‚Ä¢ Assessment / Evidence of Learning
    ‚Ä¢ Differentiation / Accommodations
    ‚Ä¢ Anticipated Difficulties/ Challenges ‚Üí Solution 
    ‚Ä¢ Follow‚Äëup / Reflection box
    `,

      "Class Materials (PPT/pictures)": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩÂÖ∑‰ΩìÁöÑ Class MaterialsÔºö
    ‚Ä¢ Presentation Topic / Focus Question
    ‚Ä¢ Expected Audience (Grade or Course)
    ‚Ä¢ Key Points / Slide Outline
    ‚Ä¢ Desired Visual Assets (images, charts, video links)
    ‚Ä¢ Desired Audio Assets (music, sound clips)
    ‚Ä¢ Branding Elements (school logo, colors, fonts)
    ‚Ä¢ Speaker‚Äënote Depth (none / bullet / full script)
     Âàó‰∏æÊØè‰∏ÄÈ°µÁöÑslidesÔºå‰ª•ÂèäslidesÈúÄË¶ÅÊúâÁõ∏ÂØπÁöÑËß£ÈáäÂõæÁâáÔºàÂ∏ÆÂä©Â≠¶ÁîüÊõ¥Â•ΩÁöÑÁêÜËß£Ôºâ


    `,

      "Report Card": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩÂÖ∑‰ΩìÁöÑ Report CardÔºö
    ‚Ä¢ Student & Class Identifiers
    ‚Ä¢ Term / Grading Period
    ‚Ä¢ Subject List & Grade Scale
    ‚Ä¢ Attendance Figures
    ‚Ä¢ Behavior /Work‚ÄëHabit Ratings
    ‚Ä¢‚ÄØOther Learning Experience/ Extra-curricular activities (jumping class/ drama class/ competition) 
    ‚Ä¢‚ÄØAward
    ‚Ä¢ Teacher Narrative Comments
    ‚Ä¢ Parent signature flag
    `,

      "Student-Work Feedback": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩÂÖ∑‰ΩìÁöÑ Student Work FeedbackÔºö
    ‚Ä¢ Student / Assignment ID
    ‚Ä¢ Rubric criteria or "Glow & Grow" fields (Strengths, Needs, Next Steps)
    ‚Ä¢ Performance level or score
    ‚Ä¢ Inline examples / Quotes
    ‚Ä¢ Overall Comment
    ‚Ä¢ Next-check-in Date
    `,

      "Subject Question Bank / Assignment": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩ Subject Question Bank / AssignmentÔºö
    ‚Ä¢ Subject & Topic Tags
    ‚Ä¢ Standard Alignment
    ‚Ä¢ Question Type (MCQ, open, etc.)
    ‚Ä¢ Difficulty Level
    ‚Ä¢ Question Text
    ‚Ä¢ Answer Choices & Correct Answer
    ‚Ä¢ Explanation / Feedback
    ‚Ä¢ Time Limit Per Item
    ‚Ä¢ Category Folder
    `,

      "Activity Plan / Extracurricular": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩ Activity PlanÔºö
    ‚Ä¢ Activity Name & Purpose
    ‚Ä¢ Date(s) / Time block
    ‚Ä¢ Location & Access notes
    ‚Ä¢ Target Group / # Students
    ‚Ä¢ Required materials & Equipment
    ‚Ä¢‚ÄØAction plan
    ‚Ä¢ Roles & supervision: resources allocation/ responsibilities
    ‚Ä¢ Risk / safety considerations
    ‚Ä¢ Assessment or reflection Method
    `,

      "Admin Helper (PPT / Word)": `
    ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊ®°ÊùøÁîüÊàê‰∏Ä‰ªΩ Admin Helper ÊñáÊ°£Ôºö
    ‚Ä¢ Document Type (agenda, newsletter, handbook, policy)
    ‚Ä¢ Audience
    ‚Ä¢ Key Sections / Talking Points
    ‚Ä¢ Attachments / Links
    ‚Ä¢ Header-footer Branding
    ‚Ä¢ Distribution Date
    `
    };

    let lastGeneratedForm = null;
    let lastUserMoreMessage = null;
    let uploadedFiles = [];
    const answers = { have: [] };
    const pendingExtractions = new Set();
    let currentStage = 0;

    const stages = [
    {
      promptKey: 'question1', key: 'type', type: 'dropdown',
      options: [
        'Lesson Plan',
        'Class Materials (PPT/pictures)',
        'Report Card',
        'Student-Work Feedback',
        'Subject Question Bank / Assignment',
        'Activity Plan / Extracurricular',
        'Admin Helper (PPT / Word)'
      ]
    },
    { promptKey: 'question2', key: 'why',   type: 'text' },
    { promptKey: 'question3', key: 'have',  type: 'text' },
    { promptKey: 'question4', key: 'more',  type: 'text' },
    { promptKey: 'question5', key: 'refine',type: 'yesno' }
  ];

    const inputArea = document.getElementById('input-area');

    document.getElementById('ocr-lang').dispatchEvent(new Event('change'));


  
    inputArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      inputArea.style.border = '2px dashed #10a37f';
      inputArea.style.backgroundColor = '#f3fffa';
    });

    inputArea.addEventListener('dragleave', () => {
      inputArea.style.border = '';
      inputArea.style.backgroundColor = '';
    });

    inputArea.addEventListener('drop', (e) => {
      e.preventDefault();
      inputArea.style.border = '';
      inputArea.style.backgroundColor = '';
      const files = e.dataTransfer.files;
      if (files.length) handleDroppedFiles(files);
    });

    function handleDroppedFiles(fileList) {
      [...fileList].forEach(file => {
        if (!answers.have) answers.have = []; 

        const fileRecord = {
          id: crypto.randomUUID(),
          name: file.name,
          note: '',
          text: ''
        };

        extractAndStore(fileRecord, file);
        answers.have.push(fileRecord);


        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';

        const span = document.createElement('span');
        span.textContent = file.name;

        const note = document.createElement('input');
        note.className = 'file-note';
        note.placeholder = 'Add note...';
        note.oninput = (e) => fileRecord.note = e.target.value;

        const delBtn = document.createElement('button');
        delBtn.textContent = '‚úï';
        delBtn.onclick = () => {
          fileItem.remove();
          answers.have = answers.have.filter(f => f.id !== fileRecord.id);
        };

        fileItem.append(span, note, delBtn);
        document.getElementById('file-preview').appendChild(fileItem);

      });
    }


    function appendMessage(content, sender, stageIndex = null, asHTML = false) {
      content = content || '';
      const container = document.createElement('div');
      container.className = `message ${sender}`;
      container.dataset.stageIndex = stageIndex;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = sender === 'bot' ? 'ü§ñ' : 'üßë‚Äçüè´';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      
      if (asHTML) {
        bubble.innerHTML = DOMPurify.sanitize(content);
      } else {
        bubble.textContent = content;
      }

      if (sender === 'user') {
        bubble.style.cursor = 'pointer';
        bubble.title = 'Click to edit';
        bubble.addEventListener('click', () => {
          if (!bubble.querySelector('a')) { // Don't allow editing if contains links
            const newValue = prompt('Edit your response:', bubble.textContent);
            if (newValue !== null && newValue.trim() !== '') {
              const confirmed = confirm('This will delete all responses after this point. Continue?');
              if (!confirmed) return;

              bubble.textContent = newValue.trim();
              const stageIdx = Number(container.dataset.stageIndex);
              
              const stageKey = stages[stageIdx].key;
              answers[stageKey] = newValue.trim();
              currentStage = stageIdx + 1;
              
              if (stageKey === 'type') {
                const dropdown = document.querySelector('select.select-inline');
                if (dropdown) dropdown.value = newValue.trim();
              }

              for (let i = stageIdx + 1; i < stages.length; i++) {
                delete answers[stages[i].key];
              }

              let next = container.nextSibling;
              while (next) {
                const toRemove = next;
                next = next.nextSibling;
                toRemove.remove();
              }

              showStage();
            }
          }
        });
      }

      container.appendChild(avatar);
      container.appendChild(bubble);
      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
      return container;
    }


    async function callDeepSeek(promptText) {
      const apiKey = 'sk-816d9a802e5f4c8ab73459a40791d7db'; 
      const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'deepseek-reasoner', 
          messages: [
            { role: 'system', content: 'You are an experienced AI education specialist, skilled at explaining complex concepts in a clear and engaging manner while providing personalized guidance tailored to students at different learning levels. Provide details plan for user(teacher)' },
            { role: 'user', content: promptText }
          ],
          temperature: 0.7
        }),
      });

      const data = await response.json();
      if (data.choices && data.choices.length > 0) {
      return data.choices[0].message.content;
    } else {
      throw new Error('No response from DeepSeek API');
    }
  }
    
      async function generateImageSearchLinksViaLLM(fullPrompt) {
    const imagePrompt = `
  ‰Ω†ÊòØ‰∏Ä‰∏™ÊïôËÇ≤Á±ªÂõæÂÉèÂª∫ËÆÆÂä©Êâã„ÄÇËØ∑‰ªé‰∏ãÈù¢ËøôÊÆµÊñáÊú¨‰∏≠ÔºåÊèêÂèñ 2-5 ‰∏™ÊúÄÈÄÇÂêàÁî®‰∫éÊêúÁ¥¢ÊïôÂ≠¶Áõ∏ÂÖ≥ÂõæÁâáÁöÑÂÖ≥ÈîÆËØçÊàñÁü≠ËØ≠„ÄÇÂÆÉ‰ª¨Â∫îÂáÜÁ°ÆÂèçÊò†ÂÜÖÂÆπ‰∏ªÈ¢òÔºåÈÄÇÂêàÁî®‰∫é Google ÂõæÁâáÊêúÁ¥¢„ÄÇ‰ªÖËøîÂõûÂÖ≥ÈîÆËØçÂàóË°®Ôºå‰∏çÈúÄË¶ÅËß£ÈáäÊàñÂºïÂè∑„ÄÇ

  „ÄêÊïôÂ≠¶ÂÜÖÂÆπ„ÄëÔºö
  ${fullPrompt}

  „ÄêËæìÂá∫Ê†ºÂºè„ÄëÔºö
  - ...
  - ...
  - ...
    `.trim();

    const result = await callDeepSeek(imagePrompt);
    return result
      .split('\n')
      .map(line => line.replace(/^[-‚Ä¢*]\s*/, '').trim())
      .filter(Boolean)
      .map(p => `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(p)}`);
  }


    function showStage() {
      const stage = stages[currentStage];
      if (!stage) {
        console.error('Invalid stage:', currentStage);
        return;
      }
      console.log('Showing stage:', currentStage, stage);

      const promptTxt = t(stage.promptKey);
      console.log('Prompt text:', promptTxt);

      if (stage.key === 'have') {
        appendMessage(promptTxt, 'bot', currentStage);
        
        // Show the stage-3 container
        const stage3 = document.getElementById('stage-3');
        if (!stage3) {
          console.error('Stage 3 container not found');
          return;
        }
        stage3.style.display = 'block';
        
        // Update button texts with translations
        const buttons = stage3.querySelectorAll('.choice-btn');
        if (buttons.length >= 2) {
          const [uploadBtn, browseBtn] = buttons;
          uploadBtn.textContent = t('uploadFiles');
          browseBtn.textContent = t('browseDatabase');
        } else {
          console.error('Choice buttons not found');
        }
        
        // Show upload section by default
        showUploadSection();
        return;
      }

      if (stage.type === 'dropdown') {
        appendMessage(promptTxt, 'bot', currentStage);
        
        // build button list container
        const container = document.createElement('div');
        container.className = 'message bot';
        container.dataset.stageIndex = currentStage;
        container.style.display = 'flex';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = 'ü§ñ';

        const btnGroup = document.createElement('div');
        Object.assign(btnGroup.style, {
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          marginLeft: '44px'
        });

        stage.options.forEach(optConst => {
          const btn = document.createElement('button');
          btn.dataset.optKey = optConst;
          btn.textContent = trType(optConst);

          Object.assign(btn.style, {
            padding: '10px 16px',
            border: '1px solid #ccc',
            borderRadius: '6px',
            background: 'white',
            cursor: 'pointer',
            fontFamily: 'Inter',
            transition: '0.2s'
          });

          btn.onmouseover = () => {
            if (!btn.classList.contains('selected')) {
              btn.style.background = '#f0f0f0';
            }
          };
          btn.onmouseout = () => {
            if (!btn.classList.contains('selected')) {
              btn.style.background = 'white';
            }
          };

          btn.onclick = () => handleChooseType(btn, optConst);

          btnGroup.appendChild(btn);
        });

        container.append(avatar, btnGroup);
        chat.appendChild(container);
        chat.scrollTop = chat.scrollHeight;
        return;
      }

      if (stage.type === 'yesno') {
        appendMessage(promptTxt, 'bot', currentStage);

        const container = document.createElement('div');
        container.className = 'message bot';
        container.dataset.stageIndex = currentStage;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = 'ü§ñ';

        const btnGroup = document.createElement('div');
        Object.assign(btnGroup.style, {
          display: 'flex',
          gap: '12px',
          marginLeft: '44px'
        });

        ['yes', 'no'].forEach(key => {
          const btn = document.createElement('button');
          btn.textContent = t(key);
          Object.assign(btn.style, {
            padding: '8px 14px',
            borderRadius: '6px',
            background: 'white',
            border: '1px solid #ccc',
            cursor: 'pointer'
          });

          btn.onclick = () => {
            appendMessage(t(key === 'yes' ? 'pleaseRefine' : 'noThanks'), 'user', currentStage);
            answers[stage.key] = key;
            currentStage++;
            if (key === 'yes') {
              askRefineSections();
            } else {
              appendMessage(t('done'), 'bot');
            }
          };

          btnGroup.appendChild(btn);
        });

        container.append(avatar, btnGroup);
        chat.appendChild(container);
        chat.scrollTop = chat.scrollHeight;
        return;
      }

      appendMessage(promptTxt, 'bot', currentStage);
    }

    let reviewTableContainer = null;
    let lastGeneratedResult = null;   
    let refineOptionsContainer = null;   
    let refineChoiceContainer = null;

    function removeNodesAfter(node) {
      if (!node) return;
      let nxt = node.nextSibling;
      while (nxt) {
        const tmp = nxt;
        nxt = nxt.nextSibling;
        tmp.remove();
      }
    }

    function renderMoreForm() {
      console.log('Starting renderMoreForm');
      lastGeneratedForm?.remove();
      lastUserMoreMessage?.remove();

      const container = document.createElement('div');
      container.className = 'message bot';
      container.dataset.stageIndex = currentStage;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = 'ü§ñ';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const promptText = document.createElement('div');
      promptText.textContent = t('morePrompt');
      promptText.style.marginBottom = '8px';

      const form = document.createElement('div');
      Object.assign(form.style, {
        display: 'flex',
        flexDirection: 'column',
        gap: '8px',
      });

      const promptInput = makeInput(t('ph_comment'));
      const gradeInput = makeInput(t('ph_grade'));
      const studentCountInput = makeInput(t('ph_students'));
      const durationInput = makeInput(t('ph_duration'));
      const lengthInput = makeInput(t('ph_length'));

      [promptInput, gradeInput, studentCountInput, durationInput, lengthInput]
        .forEach(inp => form.appendChild(inp));

      const submitBtn = document.createElement('button');
      submitBtn.textContent = t('saveBtn');
      Object.assign(submitBtn.style, {
        marginTop: '6px',
        padding: '6px 12px',
        background: '#10a37f',
        color: '#fff',
        border: 'none',
        borderRadius: '6px',
        cursor: 'pointer',
      });

      submitBtn.onclick = () => {
        console.log('Submit button clicked in more form');
        removeNodesAfter(container);
        const prompt = promptInput.value.trim();
        const grade = gradeInput.value.trim();
        const students = studentCountInput.value.trim();
        const duration = durationInput.value.trim();
        const length = lengthInput.value.trim();

        if (!prompt && !grade && !students && !duration && !length) {
          alert(t('pleaseFill'));
          return;
        }

        lastUserMoreMessage = null;
        lastGeneratedResult = null;
        reviewTableContainer = null;
        refineOptionsContainer = null;
        refineChoiceContainer = null;

        const na = t('na');
        
        // ÁÆÄÂåñÁöÑËØ¶ÊÉÖÊòæÁ§∫Ê†ºÂºè
        const userInfo = [
          'üìå Details:',
          `Comment: ${prompt || na}`,
          `Grade: ${grade || na}`,
          `Number of Students: ${students || na}`,
          `Duration: ${duration || na}`,
          `Length: ${length || na}`
        ].join('\n');

        lastUserMoreMessage = appendMessage(userInfo, 'user', currentStage, false);

        answers['more'] = { prompt, grade, students, duration, length };
        answers['studentsGrade'] = `${students || 'N/A'} / ${grade || 'N/A'}`;
        
        appendMessage(t('infoCollected'), 'bot');
        
        console.log('Moving to next stage after more form');
        currentStage++;
        if (currentStage < stages.length) {
          showStage();
        } else {
          generateContent();
        }
      };

      form.appendChild(submitBtn);
      bubble.append(promptText, form);
      container.append(avatar, bubble);
      chat.appendChild(container);
      lastGeneratedForm = container;
      chat.scrollTop = chat.scrollHeight;
    }

    function makeInput(placeholder) {
      const inp = document.createElement('input');
      inp.placeholder = placeholder;
      Object.assign(inp.style, {
        padding: '6px',
        border: '1px solid #ccc',
        borderRadius: '6px',
        fontFamily: 'Inter',
      });
      return inp;
    }

    const langSelector = document.getElementById('ocr-lang');
    let currentLang = langSelector.value;

    function t(key, vars = {}) {
      let s = translations[currentLang]?.[key] || translations.eng[key] || key;
      for (const [k, v] of Object.entries(vars)) s = s.replace(`{${k}}`, v);
      return s;
    }

    langSelector.addEventListener('change', () => {
      currentLang = langSelector.value;
      updateUIText(); 
      refreshStage0UI();    
    });


    function extractFileId(driveUrl) {
      const m = driveUrl.match(/\/d\/([^/]+)\//);
      return m ? m[1] : '';
    }

    async function onItemClick(divEl, fileId, title) {
      document.querySelectorAll('.book-item').forEach(el => el.classList.remove('selected'));
      divEl.classList.add('selected');
      
      // Show PDF preview section
      const pdfPreview = document.getElementById('pdf-preview');
      pdfPreview.style.display = 'block';
      
      // Clear previous PDF
      const pdfContainer = document.getElementById('pdf-container');
      pdfContainer.innerHTML = '<p style="padding: 20px;">Loading PDF preview...</p>';
      
      try {
        // Create a viewer container that will host the Google Drive preview
        const viewerContainer = document.createElement('div');
        viewerContainer.style.width = '100%';
        viewerContainer.style.height = '600px';
        viewerContainer.style.position = 'relative';
        viewerContainer.style.overflow = 'hidden';
        viewerContainer.style.backgroundColor = '#f5f5f5';
        viewerContainer.style.borderRadius = '8px';
        
        // Create the preview iframe
        const iframe = document.createElement('iframe');
        iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        
        // Add loading indicator that will be hidden once iframe loads
        const loadingIndicator = document.createElement('div');
        loadingIndicator.style.position = 'absolute';
        loadingIndicator.style.top = '50%';
        loadingIndicator.style.left = '50%';
        loadingIndicator.style.transform = 'translate(-50%, -50%)';
        loadingIndicator.style.textAlign = 'center';
        loadingIndicator.innerHTML = `
          <div style="margin-bottom: 15px;">
            <img src="loading.gif" alt="Loading..." style="width: 40px; height: 40px;">
          </div>
          <div style="color: #666;">Âä†ËΩΩÈ¢ÑËßà‰∏≠...</div>
        `;
        
        // Add iframe load event listener
        iframe.onload = () => {
          loadingIndicator.style.display = 'none';
        };
        
        // Add elements to container
        viewerContainer.appendChild(loadingIndicator);
        viewerContainer.appendChild(iframe);
        
        // Clear container and add viewer
        pdfContainer.innerHTML = '';
        pdfContainer.appendChild(viewerContainer);
        
        // Store selected file info
        window.selectedDriveFile = { fileId, title };
        
        // Setup confirm button
        const confirmBtn = document.getElementById('confirm-selection');
        confirmBtn.textContent = t('confirmSelection');
        confirmBtn.style.display = 'block';
        confirmBtn.style.marginTop = '20px';
        
        // Remove any existing event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        // Add new event listener
        newConfirmBtn.addEventListener('click', () => {
          console.log('Confirm button clicked');
          handleDatabaseFileSelection(fileId, title);
        });
        
      } catch (error) {
        console.error('Error loading PDF:', error);
        pdfContainer.innerHTML = `
          <div style="color: red; padding: 20px; text-align: center;">
            <p style="margin-bottom: 15px;">Êó†Ê≥ïÂä†ËΩΩÈ¢ÑËßàÔºåËØ∑Â∞ùËØï‰ª•‰∏ãÊñπÂºèÔºö</p>
            <a href="https://drive.google.com/file/d/${fileId}/view" target="_blank" class="choice-btn" style="display: inline-block; text-decoration: none; margin-bottom: 15px;">
              Âú®Êñ∞Á™óÂè£‰∏≠ÊâìÂºÄ
            </a>
            <p style="color: #666; font-size: 14px;">
              ÊèêÁ§∫ÔºöÊÇ®‰ªçÂèØ‰ª•ÁÇπÂáª"Á°ÆËÆ§ÈÄâÊã©"ÁªßÁª≠‰∏ã‰∏ÄÊ≠•
            </p>
          </div>
        `;
      }
    }

    function handleDatabaseFileSelection(fileId, title) {
      console.log('Handling database file selection:', { fileId, title });
      
      if (!answers.have) {
        console.log('Initializing answers.have array');
        answers.have = [];
      }
      
      // Add file to answers with more detailed information
      const fileEntry = {
        id: fileId,
        name: title,
        source: 'database',
        url: `https://drive.google.com/file/d/${fileId}/view`,
        type: 'pdf'
      };
      console.log('Adding file entry:', fileEntry);
      answers.have.push(fileEntry);

      // Create clickable message with file link
      const fileMessage = `Selected file from database: <a href="${fileEntry.url}" class="uploaded-file" target="_blank">üìö ${title}</a>`;
      appendMessage(fileMessage, 'user', currentStage, true);
      
      // Hide both the database browser and the entire stage-3 container
      document.getElementById('db-browser-container').style.display = 'none';
      document.getElementById('stage-3').style.display = 'none';
      
      // Enable next step
      console.log('Current stage before increment:', currentStage);
      currentStage++;
      console.log('Current stage after increment:', currentStage);
      
      if (currentStage < stages.length) {
        console.log('Moving to next stage:', stages[currentStage]);
        if (stages[currentStage].key === 'more') {
          console.log('Rendering more form');
          renderMoreForm();
        } else {
          console.log('Showing next stage');
          showStage();
        }
      }
    }

    function parseGradeOrder(title) {
      const match = title.match(/([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠])Âπ¥Á∫ß([‰∏ä‰∏ã])ÂÜå/);
      if (!match) return 999;
      const gradeMap = { ‰∏Ä: 1, ‰∫å: 2, ‰∏â: 3, Âõõ: 4, ‰∫î: 5, ÂÖ≠: 6 };
      const termMap = { ‰∏ä: 0, ‰∏ã: 1 };
      const grade = gradeMap[match[1]] || 0;
      const term = termMap[match[2]] || 0;
      return grade * 10 + term;
    }

    function renderGroupedList(bookList) {
      const container = document.getElementById('item-list');
      container.innerHTML = '';

      const groupMap = {};
      bookList.forEach(book => {
        const group = book.path || 'Êú™ÂàÜÁ±ª';
        if (!groupMap[group]) groupMap[group] = [];
        groupMap[group].push(book);
      });

      const sortedGroupNames = Object.keys(groupMap).sort();
      sortedGroupNames.forEach(group => {
        const title = document.createElement('div');
        title.className = 'group-title';
        title.textContent = `üìÇ ${group}`;
        container.appendChild(title);

        const sortedBooks = groupMap[group].sort((a, b) =>
          parseGradeOrder(a.title) - parseGradeOrder(b.title) ||
          a.title.localeCompare(b.title)
        );

        sortedBooks.forEach(book => {
          const div = document.createElement('div');
          div.className = 'book-item';
          div.textContent = book.title;
          const fileId = extractFileId(book.drive_url);
          div.dataset.fileId = fileId;

          div.addEventListener('click', () => onItemClick(div, fileId, book.title));
          container.appendChild(div);
        });
      });
    }

    function updateUIText() {
      document.getElementById('question3-title').textContent = t('question3');
      document.getElementById('db-browser-label').textContent = t('browseFiles');
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateUIText();
      renderGroupedList(books);

      document.querySelectorAll('input[placeholder]').forEach(inp => {
        switch (inp.placeholder) {
          case translations.eng.ph_comment:   inp.placeholder = t('ph_comment'); break;
          case translations.eng.ph_grade:     inp.placeholder = t('ph_grade'); break;
          case translations.eng.ph_students:  inp.placeholder = t('ph_students'); break;
          case translations.eng.ph_duration:  inp.placeholder = t('ph_duration'); break;
          case translations.eng.ph_length:    inp.placeholder = t('ph_length'); break;
        }
      });

      const filterInput = document.getElementById('filter-input');
      if (filterInput) {
        filterInput.addEventListener('input', (e) => {
          const kw = e.target.value.trim().toLowerCase();
          const filtered = books.filter(b =>
            b.title.toLowerCase().includes(kw) || b.path.toLowerCase().includes(kw)
          );
          renderGroupedList(filtered);
        });
      }
    });

    langSelector.addEventListener('change', () => {
      currentLang = langSelector.value;
      updateUIText();
    });

    function trType(opt) {
      switch (opt) {
        case 'Lesson Plan': return t('type_lesson');
        case 'Class Materials (PPT/pictures)': return t('type_materials');
        case 'Report Card': return t('type_report');
        case 'Student-Work Feedback': return t('type_feedback');
        case 'Subject Question Bank / Assignment': return t('type_bank');
        case 'Activity Plan / Extracurricular': return t('type_activity');
        case 'Admin Helper (PPT / Word)': return t('type_admin');
        default: return opt;
      }
    }

    function addFilePreviewRow(fileRecord) {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';

      const span = document.createElement('span');
      span.textContent = fileRecord.name;

      const note = document.createElement('input');
      note.className = 'file-note';
      note.placeholder = 'Add note...';
      note.oninput = e => fileRecord.note = e.target.value;

      const del = document.createElement('button');
      del.textContent = '‚úï';
      del.onclick = () => {
        fileItem.remove();
        answers.have = answers.have.filter(f => f.id !== fileRecord.id);
      };

      fileItem.append(span, note, del);
      filePreview.appendChild(fileItem);
    }

    function validateUrls(arr) {
      const uniq = [...new Set(arr.filter(u => /^https?:\/\/.+/i.test(u)))];
      return uniq.filter(u =>
        /^https:\/\/(www\.)?(google|duckduckgo)\./i.test(u)
      );
    }


    async function generateContent() {
      await Promise.all([...pendingExtractions]);

      const uploads = answers['have'] || [];
      const fileTexts = uploads
        .map(f => (f.text ?? '').trim().slice(0, 4096))
        .filter(Boolean)
        .join('\n\n---\n\n');

      const descTexts = uploads
        .filter(f => f.description)
        .map(f => '‚Ä¢ ' + f.description)
        .join('\n');

      const selectedType = answers['type'];
      const basePrompt = topicTemplates[selectedType] || '';
      if (!basePrompt) {
        alert('‚ö†Ô∏è No corresponding template was found to generate content!');
        return;
      }

      const more = answers['more'] || {};
      const purpose = answers['why'] ? `- **Purpose / Rationale**: ${answers['why']}` : '';
      const na = t('na');
      const extraDetails = `
    Context Information:
    ${purpose}
    - **${t('label_comment')}**: ${more.prompt || na}
    - **${t('label_grade')}**: ${more.grade || na}
    - **${t('label_students')}**: ${more.students || na}
    - **${t('label_duration')}**: ${more.duration || na}
    - **${t('label_length')}**: ${more.length || na}
    `.trim();

      const docPayload = [fileTexts, descTexts].filter(Boolean).join('\n');
      const docSection = docPayload
        ? `üìÑ Source Document:\n\`\`\`\n${docPayload}\n\`\`\`` : '';

      const fullPrompt = [docSection, extraDetails, basePrompt]
        .filter(Boolean)
        .join('\n\n');

      console.log('üìù Prompt sent to DeepSeek:\n', fullPrompt);

      const loadingMsg = appendMessage('üîÑ Generating...', 'bot');
      const loadingBubble = loadingMsg.querySelector('.bubble');
      loadingBubble.innerHTML =
        `<img src="boywalking.gif" style="width:48px;height:48px;margin-right:6px;vertical-align:middle;" alt="loading">` +
        `<span>${t('pleaseWait')}</span>`;

      lastGeneratedResult = loadingMsg;

      try {
        const generated = await callDeepSeek(fullPrompt);
        let finalMd = generated;

        const imageLinks = await generateImageSearchLinksViaLLM(fullPrompt);
        if (imageLinks.length) {
          finalMd += '\n\n---\n### Suggested‚ÄØVisual‚ÄØAssets\n' +
                    imageLinks.map(u => `- <${u}>`).join('\n');
        }



        renderMarkdown(loadingBubble, finalMd);
        fullMarkdown = finalMd;

        setTimeout(askIfRefineNeeded, 500);
      } catch (err) {
        console.error(err);
        loadingBubble.textContent = '‚ùå Generation failed. Please try again.';
      }
    }

    const refineState = {
      choiceContainer: null,
      optionsContainer: null,
      promptMsg: null,
      botPromptMsg: null,
      userAnswerMsg: null,
      gotItMsg: null,
      lastSelectedBtn: null,
    };

    function generateImageLinksFromText(text, maxLinks = 6) {
      const words = text
        .replace(/[^\w\u4e00-\u9fa5\s]/g, '')  
        .toLowerCase()
        .split(/\s+/)
        .filter(w => w.length >= 3);         

      const freqMap = new Map();
      words.forEach(w => freqMap.set(w, (freqMap.get(w) || 0) + 1));

      const topKeywords = [...freqMap.entries()]
        .sort((a, b) => b[1] - a[1])
        .slice(0, maxLinks)
        .map(([w]) => w);

      const links = topKeywords.map(w =>
        `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(w)}`
      );

      return links;
    }


    function cleanupRefineUI() {
      const s = refineState;
      [s.choiceContainer, s.optionsContainer, s.promptMsg,
      s.botPromptMsg, s.userAnswerMsg, s.gotItMsg].forEach(node => node?.remove());
      Object.keys(s).forEach(k => (s[k] = null));    
    }


    function askIfRefineNeeded() {
      cleanupRefineUI();                         

      const s = refineState;
      s.promptMsg = appendMessage(t('question5'), 'bot');


      const container = document.createElement('div');
      container.className = 'message bot flex';
      container.style.gap = '12px';
      s.choiceContainer = container;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = 'ü§ñ';

      const btnGroup = document.createElement('div');
      btnGroup.style.display = 'flex';
      btnGroup.style.gap = '12px';
      btnGroup.style.marginLeft = '44px';
    }

    function askIfRefineNeeded() {

      cleanupRefineUI();                     // ‚Üê helper defined earlier

      const s = refineState;                 // shorthand


      s.promptMsg = appendMessage(t('question5'), 'bot');


      const container = document.createElement('div');
      container.className = 'message bot flex';
      container.style.gap = '12px';
      s.choiceContainer = container;         // keep a reference for later clean‚Äëup

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = 'ü§ñ';


      const btnGroup = document.createElement('div');
      Object.assign(btnGroup.style, {
        display:       'flex',
        gap:           '12px',
        marginLeft:    '44px',   // indented under the avatar
      });

  
      ['yes', 'no'].forEach(key => {
        const btn = createChoiceBtn(t(key));   // small helper, see below

        btn.onclick = () => {
          // 5a)  Highlight the button the user picked 
          updateSelection(btn);                // toggles CSS fill

          //5b)  Remove any previous user answer bubble & write a new one */
          s.userAnswerMsg?.remove();
          s.userAnswerMsg = appendMessage(
            key === 'yes' ? t('pleaseRefine') : t('noThanks'),
            'user'
          );

          // 5c  If they chose "Yes", show the checkbox list 
          if (key === 'yes') {
            s.gotItMsg?.remove();              // in case user switched from "No"
            s.optionsContainer?.remove();
            s.optionsContainer = askRefineSections();   // creates the list
          } else {
            // 5d)  If "No", hide the options list (if any) and show final message */
            s.optionsContainer?.remove();
            s.botPromptMsg?.remove();
            s.botPromptMsg   = null;
            s.optionsContainer = null;      
            s.gotItMsg?.remove();
            s.gotItMsg = appendMessage(t('done'), 'bot');
          }
        };

        btnGroup.appendChild(btn);
      });


      container.append(avatar, btnGroup);
      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;


      function createChoiceBtn(text) {
        const btn = document.createElement('button');
        Object.assign(btn.style, {
          padding:    '8px 14px',
          borderRadius:'6px',
          background: 'white',
          color:      'black',
          border:     '1px solid #ccc',
          cursor:     'pointer',
          transition: '0.2s',
        });
        btn.textContent = text;
        return btn;
      }


      function updateSelection(btn) {
        if (s.lastSelectedBtn) {
          s.lastSelectedBtn.classList.remove('selected');
        }
        btn.classList.add('selected');
        s.lastSelectedBtn = btn;
      }
    }

    function refreshStage0UI() {
      const promptBubble = document.querySelector('[data-stage-index="0"] .bubble');
      if (promptBubble) promptBubble.textContent = t('question1');

      document.querySelectorAll('button[data-opt-key]').forEach(btn => {
        btn.textContent = trType(btn.dataset.optKey);
      });
    }


    function renderMarkdown(bubble, md) {
      md = md.trim().replace(/^```(markdown)?\n?/i, '').replace(/```$/, '');
      md = md
        .replace(/" | "/g, '"')
        .replace(/' | '/g, "'")
        .replace(/„Äê/g, '[').replace(/„Äë/g, ']')
        .replace(/Ôºä/g, '*')
        .replace(/^[\s\t]*[‚Ä¢‚ñ™‚ó¶‚Ä£]\s+/gm, '* ')
        .replace(/^[\s\t]*¬∑\s+/gm, '* ')
        .replace(
          /(^|\n)(\s*[*-]\s+)(Slide|Round|Scenario|Step|Phase|Station)\s+([\dA-Za-z]+:)/g,
          (_, brk, bullet, kw, rest) => `${brk}${bullet}**${kw} ${rest}**`
        )
        .replace(
          /(^|\n)(\s{4,}[*-]\s+)([A-Za-z\u4e00-\u9fa5][^:\n]{1,40}?):/g,
          (_, brk, bullet, heading) => `${brk}${bullet}**${heading}:**`
        );
              

      bubble.innerHTML = DOMPurify.sanitize(marked.parse(md));

      const openInNewTab = true;   

      bubble.querySelectorAll('a').forEach(a => {
        if (openInNewTab) {
          a.target = '_blank';             
          a.rel = 'noopener noreferrer';      
        } else {
          a.removeAttribute('target');     
          a.rel = 'noopener';             
        }
      });

    }

    function handleChooseType(btn, optConst) {
      const stageKey = 'type';
      const oldChoice = answers[stageKey];
      const newLabel = trType(optConst);

      if (oldChoice && oldChoice !== optConst) {
        const ok = confirm(`${t('replaceConfirm', { filename: oldChoice })}\n‚Üí ${newLabel}`);
        if (!ok) return;
      }

      // Remove selected class from all buttons and add it to the clicked one
      document.querySelectorAll('button[data-opt-key]').forEach(b => {
        b.classList.remove('selected');
      });
      btn.classList.add('selected');

      answers[stageKey] = optConst;

      const oldBubble = document.querySelector('.message.user[data-stage-index="0"]');
      if (oldBubble) oldBubble.remove();

      appendMessage(newLabel, 'user', 0);

      for (let i = 1; i < stages.length; i++) delete answers[stages[i].key];
      const messages = Array.from(chat.children);
      messages.forEach(el => {
        const idx = Number(el.dataset?.stageIndex);
        if (!isNaN(idx) && idx > 0) el.remove();
      });

      currentStage = 1;
      showStage();
    }

    
    function askRefineSections() {
      const type   = answers['type'];
      const fields = (templateSections[type] || {})[currentLang] ||
                    templateSections[type].eng;
      if (!fields?.length) return;

      const s = refineState;
      s.botPromptMsg = appendMessage(t('refineWhich'), 'bot');


      const wrap = document.createElement('div');
      wrap.className = 'message bot';
      wrap.style.flexDirection = 'column';
      wrap.style.marginLeft = '44px';
      wrap.style.gap = '8px';
      s.optionsContainer = wrap;

      const cbGroup = document.createElement('div');
      Object.assign(cbGroup.style, {
        display: 'flex', flexDirection: 'column',
        gap: '6px', marginLeft: '44px'
      });

      const selected = new Set();
      fields.forEach(f => {
        const lab = document.createElement('label');
        lab.style.display = 'flex';
        lab.style.alignItems = 'center'; lab.style.gap = '6px';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.onchange = () => cb.checked ? selected.add(f) : selected.delete(f);

        const span = document.createElement('span');
        span.textContent = f;

        lab.append(cb, span);
        cbGroup.appendChild(lab);
      });

 
      const okBtn = document.createElement('button');
      okBtn.textContent = t('regenerateBtn');
      Object.assign(okBtn.style, {
        alignSelf: 'flex-start', marginLeft: '44px',
        padding: '8px 14px', borderRadius: '6px',
        background: '#10a37f', color: 'white',
        border: 'none', cursor: 'pointer'
      });

      okBtn.onclick = async () => {
        if (!selected.size) {
          alert(t('atLeastOnePart'));
          return;
        }


        const partList = [...selected];
        appendMessage(
          `${t('pleaseRefine')}\n- ${partList.join('\n- ')}`,
          'user'
        );


        const loadingMsg    = appendMessage('‚è≥ Regenerating‚Ä¶', 'bot');
        const loadingBubble = loadingMsg.querySelector('.bubble');
        loadingBubble.innerHTML =
  `<img src="boywalking.gif" style="width:48px;height:48px;margin-right:6px;vertical-align:middle;" alt="loading">` +
  `<span>${t('pleaseWait')}</span>`;

        const prompt = `
        You are revising a teacher document.

        ### Previous draft (markdown)
        \`\`\`
        ${fullMarkdown}
        \`\`\`

        ### Task
        Rewrite **only** the following section(s) with richer detail, leaving everything else unchanged:

        ${partList.map(p => '- ' + p).join('\n')}

        Return **only those rewritten sections** in markdown, starting with their original headings.  
        **Do not include triple backticks (\`\`\`) or any code blocks in your response.**
        `;


        try {
          const refined = await callDeepSeek(prompt);
          renderMarkdown(loadingBubble, refined); 
          //loadingBubble.innerHTML = marked.parse(refined);
          fullMarkdown = mergeSections(fullMarkdown, refined);
          askIfRefineNeeded();
        } catch (e) {
          console.error(e);
          loadingBubble.textContent = t('generationFailed');
        }
      };

      wrap.append(cbGroup, okBtn);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return wrap;
    }




    function extractAndStore(fileRecord, file) {
      fileRecord.text = '‚åõ extracting‚Ä¶';

    // create + start extraction
    const promise = extractTextFromFile(file)
      .then(txt => {
        fileRecord.text = (txt || '').trim() || '(empty file)';
      })
      .catch(err => {
        console.error('Extraction error ‚Üí', err);      // full stack
        fileRecord.text = `‚ùå Failed: ${err.message || err}`;
      })
      .finally(() => pendingExtractions.delete(promise));  // clean up

    pendingExtractions.add(promise);


    }

    function validateState() {
      // Check if current stage is valid
      if (currentStage < 0 || currentStage >= stages.length) {
        console.error('Invalid stage index:', currentStage);
        return false;
      }

      // Check if we have all required answers up to current stage
      for (let i = 0; i < currentStage; i++) {
        const key = stages[i].key;
        if (!answers[key]) {
          console.error('Missing answer for stage', i, key);
          return false;
        }
      }

      return true;
    }

    function handleUserInput() {
      if (!validateState()) {
        console.error('Invalid state detected');
        return;
      }

      const stageKey = stages[currentStage]?.key;
      const value = input.value.trim();
      let advanced = false;

      if (stageKey === 'have') {
        const uploadedFiles = document.getElementById('user-upload')?.files;
        if (!uploadedFiles) {
          console.error('File input not found');
          return;
        }

        const hasFiles = uploadedFiles.length > 0;
        const hasText = value.length > 0;
        const selectedFile = window.selectedDriveFile;

        if (!hasFiles && !hasText && !selectedFile) {
          alert(t('pleaseFill'));
          return;
        }

        if (!answers[stageKey]) answers[stageKey] = [];

        if (hasFiles) {
          Array.from(uploadedFiles).forEach(file => {
            const fileRecord = {
              id: crypto.randomUUID(),
              name: file.name,
              note: '',
              text: ''
            };
            answers[stageKey].push(fileRecord);
            extractAndStore(fileRecord, file);
          });
        }

        if (selectedFile) {
          answers[stageKey].push({
            id: selectedFile.fileId,
            name: selectedFile.title,
            note: '',
            text: '(Database file)'
          });
        }

        if (hasText) {
          answers[stageKey].push({ description: value });
        }

        appendMessage(
          [
            ...(hasFiles ? Array.from(uploadedFiles).map(f => `üìé ${f.name}`) : []),
            ...(selectedFile ? [`üìö ${selectedFile.title}`] : []),
            ...(hasText ? [`üìù ${value}`] : [])
          ].join('\n'),
          'user',
          currentStage
        );

        // Hide stage-3 container after file upload
        const stage3 = document.getElementById('stage-3');
        if (stage3) {
          stage3.style.display = 'none';
        }

        input.value = '';
        advanced = true;
      } else if (value) {
        answers[stageKey] = value;
        appendMessage(value, 'user', currentStage);
        input.value = '';
        advanced = true;
      }

      if (advanced) {
        currentStage++;
        if (currentStage < stages.length) {
          console.log('Moving to next stage:', currentStage, stages[currentStage].key);
          if (stages[currentStage].key === 'more') {
            renderMoreForm();
          } else {
            showStage();
          }
        } else {
          console.log('All stages complete, generating content');
          generateContent();
        }
      }
    }

    input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault(); 
      handleUserInput();
    }
  });




  async function extractTextFromDocx(file) {
    const { value } = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
    return value;
  }

  async function extractTextFromImage(file) {
  const result = await Tesseract.recognize(file, 'chi_sim+chi_tra+eng', {
    logger: m => console.log(m.status, m.progress)
  });
  return result.data.text;
}

  async function extractTextFromPDF(file) {
    try {
      const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
      let text = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        text += pageText + '\n';
      }

      if (text.trim()) return text.trim();

      throw new Error('empty text layer');
    } catch (err) {
      console.warn('Text extraction failed, switching to OCR ‚Üí', err.message);

      // OCR fallback
      const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
      let ocrText = '';

      for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: context, viewport }).promise;

        const { data } = await Tesseract.recognize(canvas, 'chi_sim+chi_tra+eng');
        ocrText += data.text + '\n';
      }

      return ocrText.trim() || '‚ö†Ô∏è OCR produced no text.';
    }
  }

    async function extractTextFromFile(file) {
      const name = file.name.toLowerCase();

      if (name.endsWith('.pdf')) {
        return await extractTextFromPDF(file);
      } else if (name.endsWith('.docx')) {
        return await extractTextFromDocx(file);
      } else if (/\.(png|jpg|jpeg)$/i.test(name)) {
        return await extractTextFromImage(file);
      } else {
        return `‚ö†Ô∏è Unsupported file type: ${file.name}`;
      }
    }

    function mergeSections(oldDoc, patchDoc) {

      const blocks = patchDoc.split(/^###\s+/m).filter(b => b.trim());

      blocks.forEach(block => {
        const heading = block.split('\n')[0].trim();
        const body    = block.replace(heading, '').trimStart();
        const hEsc    = escapeRegExp(heading);
        const re = new RegExp(`###\\s+${hEsc}[\\s\\S]*?(?=\\n###|$)`, 'm');

        if (re.test(oldDoc)) {
          oldDoc = oldDoc.replace(re, `### ${heading}\n${body}`);
        } else {
          oldDoc += `\n\n### ${heading}\n${body}`;
        }
      });
      return oldDoc;
    }



      // hidden input reused for every replacement
    const replaceInput = document.createElement('input');
    replaceInput.type = 'file';
    replaceInput.style.display = 'none';
    document.body.appendChild(replaceInput);

    function triggerReplace(fileRecord) {
      replaceInput.onchange = () => {
        const newFile = replaceInput.files[0];
        if (!newFile) return;                       // user hit cancel

        // wipe old text and restart extraction
        fileRecord.name = newFile.name;
        extractAndStore(fileRecord, newFile);

        // update link text 
        this.textContent = `üìé ${newFile.name}`;

        // remove ALL chat messages that come after Q3 
        pruneMessagesAfterStage(2);                

        // delete answers for stages 3‚Äë4‚Äë5 so user must re‚Äëfill 
        ['more', 'refine'].forEach(k => delete answers[k]);

        currentStage = 3;                           // back to Question 4
        renderMoreForm();                           // re‚Äëshow Q4 form
      };
      replaceInput.value = '';                      // reset for next use
      replaceInput.click();
    }

    function pruneMessagesAfterStage(stageIdx) {
      const msgs = Array.from(chat.children);
      for (let i = msgs.length - 1; i >= 0; i--) {
        const idx = Number(msgs[i].dataset.stageIndex);
        if (!isNaN(idx) && idx > stageIdx) msgs[i].remove();
      }
    }

    updateUIText();
    showStage();

    function showUploadSection() {
      // Update button states
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === t('uploadFiles')) {
          btn.classList.add('selected');
        }
      });

      // Show/hide sections
      document.getElementById('upload-section').style.display = 'block';
      document.getElementById('db-browser-container').style.display = 'none';
    }

    function showDatabaseSection() {
      // Update button states
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === t('browseDatabase')) {
          btn.classList.add('selected');
        }
      });

      // Show/hide sections
      document.getElementById('upload-section').style.display = 'none';
      document.getElementById('db-browser-container').style.display = 'block';
      
      // Initialize the database browser if not already done
      renderGroupedList(books);
    }

  </script>
</body>
</html>
