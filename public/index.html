<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher All in One AI Chat</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
  
  <!-- Required Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/file-saver/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  <!-- MODIFIED: Switched to a more browser-friendly library, html-docx-js. -->
  <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>
  
  <style>
    /* --- Base Styles from Webflow Version --- */
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .message {
      display: flex;
      align-items: flex-end;
      margin: 8px 0;
      width: fit-content;
      max-width: 90%;
    }
    .bot { flex-direction: row; }
    .user {
      flex-direction: row-reverse;
      align-self: flex-end;
    }
    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      animation: fadeIn 0.3s ease-in;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 16px;
      display: inline-block;
      background-color: #eeeeee;
    }
    .user .bubble { background-color: #d2f0ff; }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin: 0 8px;
      flex-shrink: 0;
    }
    #input-area {
      display: flex;
      flex-direction: column;
      padding: 10px;
      background: white;
      border-top: 1px solid #ccc;
    }
    .input-wrapper {
      display: flex;
      align-items: center;
    }
    #user-input {
      flex: 1;
      min-height: 44px;
      max-height: 300px;
      resize: vertical;
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #file-upload { display: none; }
    .tooltip-wrapper {
      position: relative;
      display: inline-block;
    }
    #file-button {
      background-color: white;
      border: none;
      font-size: 20px;
      margin: 0 10px;
      cursor: pointer;
    }
    .tooltip-text {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
    }
    .tooltip-wrapper:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    .next-button {
      padding: 10px 20px;
      background-color: #10a37f;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
    h2.centered-heading {
      font-size: 28px;
      margin-bottom: 20px;
      text-align: center;
      width: 100%;
    }
    .uploaded-file {
      color: rgb(41, 96, 198);
      text-decoration: underline;
      cursor: pointer;
    }
    .uploaded-file:hover { text-decoration: none; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    button.selected {
      background: #10a37f !important;
      border-color: #10a37f !important;
      color: white !important;
    }

    /* --- Merged Styles from Local Version --- */
    .book-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .book-item:hover { background: #f7f7f7; }
    .book-item.selected { background: #d2f0ff; }
    .group-title {
      margin: 10px 0 4px;
      font-weight: bold;
      background: #f0f0f0;
      padding: 8px 10px;
      border-radius: 4px;
    }
    .region-title {
        background: #e0e0e0;
        padding: 12px 16px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .region-title:hover { background: #d5d5d5; }
    .region-title::after {
        content: '▼';
        font-size: 12px;
        transition: transform 0.2s;
    }
    .region-title.collapsed::after { transform: rotate(-90deg); }
    .region-content {
        margin-left: 16px;
        border-left: 2px solid #e0e0e0;
        padding-left: 8px;
    }
    .choice-btn {
      padding: 10px 20px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      min-width: 120px;
    }
    .choice-btn:hover { background: #f0f0f0; }
    #stage-3-ui {
      padding: 20px;
      background: white;
      border-radius: 8px;
      margin: 10px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #upload-section {
      margin-top: 16px;
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      text-align: center;
    }
    #db-browser-container {
      margin-top: 16px;
      padding: 16px;
      border: 1px solid #eee;
      border-radius: 8px;
    }
    #filter-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 12px;
        font-size: 14px;
    }
    #filter-input:focus {
        outline: none;
        border-color: #10a37f;
        box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
    }
    .source-choice {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      justify-content: center;
    }
    #pdf-preview {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #pdf-container {
      background: #f5f5f5;
      overflow: auto;
    }
    #confirm-selection {
      width: 100%;
      margin-top: 10px;
      font-weight: 500;
    }
    #confirm-selection:hover { background: #0d8c6d !important; }
  </style>
</head>
<body>
  <div id="chat">
    <h2 class="centered-heading">👋 What do you wanna generate?</h2>
  </div>
    <div id="input-area">
    <div class="input-wrapper">
      <textarea id="user-input" rows="2"></textarea>
      <div class="tooltip-wrapper">
        <button id="file-button" onclick="document.getElementById('file-upload').click()">＋</button>
        <span class="tooltip-text">Upload File</span>
      </div>
      <input type="file" id="file-upload" multiple style="display:none;" />
      <button class="next-button" onclick="handleUserInput()">Next</button>
    </div>
  </div>
  <div id="stage-3-ui" style="display: none;">
    <h3 id="question3-title"></h3>
    <div class="source-choice">
      <button class="choice-btn" onclick="showUploadSection()">Upload Files</button>
      <button class="choice-btn" onclick="showDatabaseSection()">Browse Database</button>
    </div>
    <div id="upload-section" style="display: none;">
      <input type="file" id="stage-3-file-upload" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" multiple onchange="handleStage3FileUpload(this.files)" />
      <p>Drag & drop files here or click to select.</p>
    </div>
    <div id="db-browser-container" style="display: none;">
      <strong id="db-browser-label"></strong>
      <input type="text" id="filter-input" placeholder="🔍 Search…" />
      <div id="item-list" style="max-height: 300px; overflow-y:auto; border: 1px solid #eee; padding: 4px;"></div>
      <div id="pdf-preview" style="display: none; margin-top: 20px;">
        <h4 style="margin-bottom: 10px;">Selected File Preview:</h4>
        <div id="pdf-container" style="width: 100%; height: 500px; border: 1px solid #eee; margin-bottom: 10px;"></div>
        <button id="confirm-selection" class="choice-btn" style="background: #10a37f; color: white;">Confirm Selection</button>
      </div>
    </div>
  </div>


  <!-- Script Part 1: Data and Configuration -->
  <script>
    // Embedded book data from book.js
    const regions = { "mainland": { "name": "内地小学数学教材", "books": [ { "title": "【北师大版】一年级上册数学电子课本", "path": "北师大版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1JVKwSxf45OM2t-r54tLqAqS_PQpLFCqA/view?usp=sharing" }, { "title": "【北师大版】一年级下册数学电子课本", "path": "北师大版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1-nLQz68MPEAMUVHqkdlZCjRdGcaRFroX/view?usp=sharing" }, { "title": "【北师大版】六年级上册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1QZKWDRvtIJf_8BqfGc9ya91_sl3X7G40/view?usp=sharing" }, { "title": "【北师大版】四年级下册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1tVJgggU_-rH6rGRKvWhghWcG2xm5-wnw/view?usp=sharing" }, { "title": "【北师大版】一年级下册(2025春版)数学电子课本-社学整理", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1OQcVP1o_H_CqmDpK4td_UVmk-PeFs6DM/view?usp=sharing" }, { "title": "【北师大版】二年级下册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1aEZYqrLFBgyhc3F4rIBUm1SZOJUjj8fc/view?usp=sharing" }, { "title": "【北师大版】一年级上册(2024秋版)数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1uqsZ0hKMHffdNWIVLFQZBAl6ckEfhymB/view?usp=sharing" }, { "title": "【北师大版】四年级上册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1IpIdyohBj0XOharN18Rw2jMQVWVzwDn1/view?usp=sharing" }, { "title": "【北师大版】三年级下册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1ZMn628sFQIoLOGZ4Gskg78Hkw5pgnP1r/view?usp=sharing" }, { "title": "【北师大版】六年级下册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1iOdi0rFYq8vWKRAvOsu3Uk7e405LW_Fr/view?usp=sharing" }, { "title": "【北师大版】三年级上册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/13NDvwcKWojZBRV1-7UP56q1fnHj8vdMQ/view?usp=sharing" }, { "title": "【北师大版】二年级上册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1XLqh8wPznU3zMnWYC0tkMxwJOVADZTud/view?usp=sharing" }, { "title": "【北师大版】五年级下册数学电子课本", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1ry0e6mG8nc1RgZxSqnTJ-VNanEKwGcAF/view?usp=sharing" }, { "title": "【北师大版】五年级上册数学电子课本-社学整理", "path": "北师大版", "drive_url": "https://drive.google.com/file/d/1ytvPdIbhjRA_xJjr_w66GcOqJeTKCSli/view?usp=sharing" }, { "title": "【人教版】一年级下册数学电子课本", "path": "人教版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1wt1niMm_JdCTLMSV1O9M6ATFoABUvNPL/view?usp=sharing" }, { "title": "【人教版】一年级上册数学电子课本", "path": "人教版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1_d_zBT33RDqnAje1zkQAb1NwvNWC74lH/view?usp=sharing" }, { "title": "【人教版】三年级上册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1K7ZEThBsx0hhy9RY_C81ms6hi-ILC12k/view?usp=sharing" }, { "title": "【人教版】五年级下册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1CIiSoVf2FmJXXVoUB1X2sayNBxTl31Tf/view?usp=sharing" }, { "title": "【人教版】一年级下册(2025春版)数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1nKHaHsik_5yXxjV2ABMmz4YTp7WBLkXa/view?usp=sharing" }, { "title": "【人教版】六年级上册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/14r4RTPZ0F4UCLIH-cYDxbBeoFpHXDzIi/view?usp=sharing" }, { "title": "【人教版】四年级下册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1UwpKfwUPvAS17eSzpi48brQ2AWbUdQYI/view?usp=sharing" }, { "title": "【人教版】四年级上册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1-fsn3zR86xvGOafXlg0fGzyco3MEFyfv/view?usp=sharing" }, { "title": "【人教版】五年级上册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1eTOM29T90xpN_naTDY-Iof67DPAJCoH_/view?usp=sharing" }, { "title": "【人教版】三年级下册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1ZtqLOrEDjBuDeDjvnwFy41SbQhN8kysA/view?usp=sharing" }, { "title": "【人教版】六年级下册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/13ScZM_Z1WNIM3Tj2_KNZlGYTrtOywqOr/view?usp=sharing" }, { "title": "【人教版】二年级上册数学电子课本-社学整理", "path": "人教版", "drive_url": "https://drive.google.com/file/d/17yBbF3Dw1OYW774PfrRcewX_MN11oRUt/view?usp=sharing" }, { "title": "【人教版】一年级上册(2024秋版)数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1AlU6JnHnr8-dlyIbzJrgEjPP0W738TiX/view?usp=sharing" }, { "title": "【人教版】二年级下册数学电子课本", "path": "人教版", "drive_url": "https://drive.google.com/file/d/1LOMwLkmPWUMjhvYNnGslRmf_ziV7x0DQ/view?usp=sharing" }, { "title": "【苏教版】一年级上册数学电子课本", "path": "苏教版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1iXlgrMov2D5dSR-B6_UhW1jHND7JVcnd/view?usp=sharing" }, { "title": "【苏教版】一年级下册数学电子课本", "path": "苏教版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1GE-VPGGWcjFLBT_MNlPmotGxszk64Leg/view?usp=sharing" }, { "title": "【苏教版】三年级上册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1Wj_CKslWcX9kAh-jFWOEsD-6d1lWwr_h/view?usp=sharing" }, { "title": "【苏教版】二年级下册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1a_0_wb88J_6JnEitpX7KIIjWl4n8gtXe/view?usp=sharing" }, { "title": "【苏教版】一年级上册(2024秋版)数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1YGnICLQn7m2oPNbjGsfHpfkrF-oA-5an/view?usp=sharing" }, { "title": "【苏教版】五年级下册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1LAJEfqIkmZ7BBH9O7isgfpEe_BgYUJvK/view?usp=sharing" }, { "title": "【苏教版】三年级下册数学电子课本-社学整理", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1j7VWIUwGocZZharVHapEl8tlhlcWzmql/view?usp=sharing" }, { "title": "【苏教版】六年级下册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1pLFV9Jh0pRR60yCmCNuVi9qfizfPmLK6/view?usp=sharing" }, { "title": "【苏教版】六年级上册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1Mki_DVxSvgNyJu62OuXtPBb4T5nH19dY/view?usp=sharing" }, { "title": "【苏教版】五年级上册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1ewRcjq6_gIBLS0D1TKCp_15nzaXvK42N/view?usp=sharing" }, { "title": "【苏教版】二年级上册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1ac7gxIGPuo1hYhK4nAd2Nt5DGSwuLi5p/view?usp=sharing" }, { "title": "【苏教版】一年级下册(2025春版)数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1mjK9rpNpPjXdzNEXH9slcAQ3fNJ1deZC/view?usp=sharing" }, { "title": "【苏教版】四年级上册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1lZZ2ZCfLiP16DT3BJNcWSlOBALrKnXvX/view?usp=sharing" }, { "title": "【苏教版】四年级下册数学电子课本", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/1ZOuNtxD_L-ONWCkeJpCrQ_b8poTthCqf/view?usp=sharing" }, { "title": "【苏教版】二年级上册(2025秋版)数学电子课本（提前预习）", "path": "苏教版", "drive_url": "https://drive.google.com/file/d/16oCxNHP8QwxWPu61D-KTWg8CChi35M4l/view?usp=sharing" }, { "title": "【西南大学版】一年级下册数学电子课本", "path": "西南大学版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1Y6F0L0nJgyHKKIB-yIELh2V1ovMZxvBa/view?usp=sharing" }, { "title": "【西南大学版】一年级上册数学电子课本-社学整理", "path": "西南大学版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1Xzqo07hA-PJ0xCWNqoy3HMzAxQn6dUgJ/view?usp=sharing" }, { "title": "【西南大学版】一年级上册(2024秋版)数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1Ijq_aQox_dVsQ4_JAh6CltbN2Ukzg3ox/view?usp=sharing" }, { "title": "【西南大学版】六年级上册数学电子课本-社学整理", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/16g7FJca65FH5zC03iAKjhaYhWWUb_2m_/view?usp=sharing" }, { "title": "【西南大学版】二年级下册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1DamFf2p9IpMA65_bdsTcTrBH2swaaLrD/view?usp=sharing" }, { "title": "【西南大学版】四年级上册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1JNkmf47d-4iGuDKJ_WM4MSRWCpzHDpK9/view?usp=sharing" }, { "title": "【西南大学版】三年级下册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1oyWtpMMIANpKHOpsl2HTLjeNTrCYR0Dg/view?usp=sharing" }, { "title": "【西南大学版】一年级下册(2025春版)数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1B5tPhB4w1cmhwZZLRW356zkxKNdFHsgk/view?usp=sharing" }, { "title": "【西南大学版】五年级上册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/16pn2aY5ndxQGnbp_ILCSbour0BvKOaFn/view?usp=sharing" }, { "title": "【西南大学版】五年级下册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1TdUkHp0g80XRWV2wIPbZvQtG3qsYCTLZ/view?usp=sharing" }, { "title": "【西南大学版】二年级上册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1iyhwkyV3w-0iYQx3YygY8TQtOXY6e-5m/view?usp=sharing" }, { "title": "【西南大学版】三年级上册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1KMLeOBSX7mCmLxsBH0qgB0wV-UYK22cl/view?usp=sharing" }, { "title": "【西南大学版】六年级下册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1T7usDibsMKJCbDTDjWik_DvIWff2CR1q/view?usp=sharing" }, { "title": "【西南大学版】四年级下册数学电子课本", "path": "西南大学版", "drive_url": "https://drive.google.com/file/d/1yDtSj8yblZP2cWtouiUj_5aZKEp5UUEI/view?usp=sharing" }, { "title": "【北京版】一年级下册数学电子课本", "path": "北京版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1u-GOoSWf9HjtUEkNFARC2dxv61spGCtI/view?usp=sharing" }, { "title": "【北京版】一年级上册数学电子课本", "path": "北京版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1axFBj5V0EI2-H4yCSUlwoaIWuh6wlNTM/view?usp=sharing" }, { "title": "【北京版】一年级上册(2024秋版)数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/18LBU0Gp8w85tVBvTCAKmTnMBTnpuPWwE/view?usp=sharing" }, { "title": "【北京版】四年级上册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1MH4s6oeaAiGhRj4AonP66HizaOG2aZW1/view?usp=sharing" }, { "title": "【北京版】五年级上册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1XcUphuF761fRK4YEULsQr4uV4lGDaVRy/view?usp=sharing" }, { "title": "【北京版】三年级上册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1kO6SfkjBVQuYCMlkEnfN4r0bYkya8wgn/view?usp=sharing" }, { "title": "【北京版】二年级下册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1p46ThGNFwOZDtk6dbVKu5xBurV_0kSaH/view?usp=sharing" }, { "title": "【北京版】三年级下册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1ok35VKBX8T_T2Vfj2Sv1HfjOWb_faHC9/view?usp=sharing" }, { "title": "【北京版】六年级下册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1SQteb8onT-_6SMe1Jg_0o-b4bwaMVwba/view?usp=sharing" }, { "title": "【北京版】六年级上册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1f2ymmYhZn10Oyc-MWU2uhUanFjO26gxP/view?usp=sharing" }, { "title": "【北京版】五年级下册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/170Z6c1ysjeyoXmWCHsC6PZJqThsw3xZT/view?usp=sharing" }, { "title": "【北京版】二年级上册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1tUFLUUtEfqK-2eTrotHPMrNUVJgDVFZy/view?usp=sharing" }, { "title": "【北京版】一年级下册(2025春版)数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1BR9XwRtIDPSpkSKhfP7e-wNM7QR2pszb/view?usp=sharing" }, { "title": "【北京版】四年级下册数学电子课本", "path": "北京版", "drive_url": "https://drive.google.com/file/d/1pCq0clGJqE3Yr_uf_A-1U_YSwNk0fFtn/view?usp=sharing" }, { "title": "【青岛版】一年级下册数学电子课本", "path": "青岛版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1ntTh8SAHc6KYtVNHhBcHDXBUUepaZL_z/view?usp=sharing" }, { "title": "【青岛版】一年级上册数学电子课本-社学整理", "path": "青岛版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1xjHdtvQIxZ2YgNfcpZt1DfD-S4pGbBNQ/view?usp=sharing" }, { "title": "【青岛版】一年级上册(2024秋版)数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1SwTqGMVxARw2HZ1dkXM1wZ9Y3NeZcMwr/view?usp=sharing" }, { "title": "【青岛版】一年级下册(2025春版)数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1iylJeY8inyLpkaNP7dd3bmdE4xCMqErt/view?usp=sharing" }, { "title": "【青岛版】三年级下册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1TXyPnveT-9yUj4O3HRBfDKX1kuG7eYvx/view?usp=sharing" }, { "title": "【青岛版】四年级上册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1BApw2WTy7m2PL1-SzJmZZ-eBfHZup8ur/view?usp=sharing" }, { "title": "【青岛版】二年级上册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1-lNPTeRDOMDgeAq9b8BqUK6jgcmruhDf/view?usp=sharing" }, { "title": "【青岛版】五年级下册数学电子课本-社学整理", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1pfbNKKCXsYMU7aSDr50ctgYRXrxeMxdr/view?usp=sharing" }, { "title": "【青岛版】五年级上册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/10pZlEQ56KQzEu0SLpPKWtPxbEitIYWOM/view?usp=sharing" }, { "title": "【青岛版】三年级上册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1G0cjowxKri_bS4K5lf1sqBS9-UzYz_8e/view?usp=sharing" }, { "title": "【青岛版】六年级下册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1t4Etrz-tm5cWAeGhY_zq_NCwe6lHncDP/view?usp=sharing" }, { "title": "【青岛版】二年级下册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1Z-lMB8kjoszLcT33hGNO2JqwXerPecev/view?usp=sharing" }, { "title": "【青岛版】六年级上册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/1sH0Hz0BE66hY-KwohH8G1mT7ldusskS3/view?usp=sharing" }, { "title": "【青岛版】四年级下册数学电子课本", "path": "青岛版", "drive_url": "https://drive.google.com/file/d/187i0bxzyfSj38m_015CAp-L52rXWO34Z/view?usp=sharing" }, { "title": "【青岛版五四制】一年级下册数学电子课本", "path": "青岛版【五四制】/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1i8Oi1CFZZmwrUVQ73qO6k31dIFkWdWUQ/view?usp=sharing" }, { "title": "【青岛版五四制】一年级上册数学电子课本", "path": "青岛版【五四制】/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1yWHJQ-hRu5FVsvvhtwj33p_1UNlPKKXC/view?usp=sharing" }, { "title": "【青岛版五四制】一年级上册(2024秋版)数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1g49KiexEOK_yOG4SzsWdPC_Waq__aUvt/view?usp=sharing" }, { "title": "【青岛版五四制】一年级下册(2025春版)数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1jrKnw7cEJmQmF5IibvlqhWJSTqZIhU3f/view?usp=sharing" }, { "title": "【青岛版五四制】二年级下册数学电子课本-社学整理", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1zCLosTCn9eD7p4cPvqgQIjkS_UClJ8t2/view?usp=sharing" }, { "title": "【青岛版五四制】二年级上册数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1nJNuJk9pH6E3wkicv-zgfMB_FX0Y8jrr/view?usp=sharing" }, { "title": "【青岛版五四制】五年级下册数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1AwF1vGwrM8KnMugN-hD-LiFUfC5Qsdc-/view?usp=sharing" }, { "title": "【青岛版五四制】五年级上册数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1wC8mTYQ2TuVttS2sut1MKi5t1uOLsccC/view?usp=sharing" }, { "title": "【青岛版五四制】四年级上册数学电子课本-社学整理", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1LmKVCkMYMRfmtCDQB9Am1NuEAl3S7Cey/view?usp=sharing" }, { "title": "【青岛版五四制】三年级下册数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/12N8YXoeYuV35_P8y8bqLjHD7sUJBMbfY/view?usp=sharing" }, { "title": "【青岛版五四制】四年级下册数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1ofDAyom1YyYlFXINs7aPTMy8IZ17CIxz/view?usp=sharing" }, { "title": "【青岛版五四制】三年级上册数学电子课本", "path": "青岛版【五四制】", "drive_url": "https://drive.google.com/file/d/1jBQiN2z5QUrseePMn1PLOIkpwnBRRvHZ/view?usp=sharing" }, { "title": "【冀教版】一年级上册数学电子课本", "path": "冀教版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1YQSRP-KUZntxqIGLhTYTQeEsxAwPpWHX/view?usp=sharing" }, { "title": "【冀教版】一年级下册数学电子课本", "path": "冀教版/2011年课标旧版", "drive_url": "https://drive.google.com/file/d/1uzdJW0kKJ0VUbCda4mB98IQ8qJWcd_DY/view?usp=sharing" }, { "title": "【冀教版】六年级下册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1Os3dFkBpMHF3g3r5mxie27trAamWSSxm/view?usp=sharing" }, { "title": "【冀教版】一年级下册(2025春版)数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1T-bu984EiOdD-oIGoJlBCCjlPKG_krtT/view?usp=sharing" }, { "title": "【冀教版】五年级上册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1oC3PdNCAi1dMQNt_nFKssZHpmvuTR9fa/view?usp=sharing" }, { "title": "【冀教版】四年级上册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1FKuehQFsELPlTnnwNO4RsxmolK8rCMv2/view?usp=sharing" }, { "title": "【冀教版】四年级下册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1wSSQqPVHz9dGQ4hFItdLyEiek3Q4kNVu/view?usp=sharing" }, { "title": "【冀教版】一年级上册(2024秋版)数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/17s1C6AhnnQB7bk7j8Kxvfa6JRqnUfCUD/view?usp=sharing" }, { "title": "【冀教版】六年级上册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1m_6kHHBBE6o761prbMwaAuu0uSMCZiuE/view?usp=sharing" }, { "title": "【冀教版】三年级上册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1RnwJPPcqCjWaG6bGcawGBUnpZn-xHOnG/view?usp=sharing" }, { "title": "【冀教版】二年级下册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1bAMip8TCPA-Azm34mtq6vSQZKm27jVsY/view?usp=sharing" }, { "title": "【冀教版】三年级下册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1jU8nsVN3DQDz_v-eix1d_SzDXOkYWQCe/view?usp=sharing" }, { "title": "【冀教版】二年级上册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/15h_RhT7wSHs6EOFFseYGvV1dOvYlMnYr/view?usp=sharing" }, { "title": "【冀教版】五年级下册数学电子课本", "path": "冀教版", "drive_url": "https://drive.google.com/file/d/1Ak8EKai-WN8KG_Wvb1c_wCVO2KLyCIbE/view?usp=sharing" }, { "title": "【沪教版五四制】一年级下册(2025春版)数学电子课本", "path": "沪教版【五四制】", "drive_url": "https://drive.google.com/file/d/1PcOsI7rb5Lqap4hkIsj-oLCT4KmiPeQc/view?usp=sharing" }, { "title": "【沪教版五四制】一年级上册(2024秋版)数学电子课本", "path": "沪教版【五四制】", "drive_url": "https://drive.google.com/file/d/1GbhcYUpGW28tTSc-2iWpzRPeiVPQs0z5/view?usp=sharing" }] }, "hongkong": { "name": "香港教材", "books": [ { "title": "Student Profile", "path": "", "drive_url": "https://drive.google.com/file/d/1bnHUfa-rAmLPtbk91CHRgc7aehrJP396/view?usp=sharing" }, { "title": "Math Syllabus Chinese HK", "path": "", "drive_url": "https://drive.google.com/file/d/1OshpG5aGYvXgVWFaJUM1Vfd3p5agjepA/view?usp=sharing" }, { "title": "Lesson Plan English", "path": "", "drive_url": "https://drive.google.com/file/d/177674WEEnodKAfAqBNPDPiuBOrn1OWbB/view?usp=sharing" }, { "title": "Lesson Plan Traditional Chinese", "path": "", "drive_url": "https://drive.google.com/file/d/1tvhWDvfSaGbjv5ZrrFLmVs-mU_U3pU-M/view?usp=sharing" }, { "title": "Lesson Plan Traditional Chinese 2", "path": "", "drive_url": "https://drive.google.com/file/d/1nawxEpxd-HmbU8FwE9q-qcZdqRZMdf5t/view?usp=sharing" }, { "title": "IEP Feb 2020", "path": "", "drive_url": "https://drive.google.com/file/d/1vk9wQA9RUJkb1azjE6TClwCdF60MKUZm/view?usp=sharing" }, { "title": "IEP 教育局樣本", "path": "", "drive_url": "https://drive.google.com/file/d/1frYrJwTC1QkZNloNg-GCqtn5R5_uaWAf/view?usp=sharing" }, { "title": "IEP April 2024", "path": "", "drive_url": "https://drive.google.com/file/d/1aoO2OGCZ6cO-ce1Gx9b-pt2VxgvIToEt/view?usp=sharing" }] } };
    
    // --- State Management ---
    let currentStage = 0;
    const answers = { have: [] }; // Central state for user answers
    const pendingExtractions = new Set();
    let currentLang = document.documentElement.lang; // Use browser/Webflow language
    let fullMarkdown = '';
    let lastGeneratedForm = null;
    let lastUserMoreMessage = null;
    const refineState = {
      choiceContainer: null,
      optionsContainer: null,
      promptMsg: null,
      botPromptMsg: null,
      userAnswerMsg: null,
      gotItMsg: null,
      lastSelectedBtn: null,
    };

    // --- Configuration ---
    const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    const stages = [
      { promptKey: 'question1', key: 'type', type: 'dropdown',
        options: [
          'Lesson Plan', 'Class Materials (PPT/pictures)', 'Report Card',
          'Student-Work Feedback', 'Subject Question Bank / Assignment',
          'Activity Plan / Extracurricular', 'Admin Helper (PPT / Word)'
        ]
      },
      { promptKey: 'question2', key: 'why', type: 'text' },
      { promptKey: 'question3', key: 'have', type: 'text' }, // This stage will now trigger the new UI
      { promptKey: 'question4', key: 'more', type: 'text' },
      { promptKey: 'question5', key: 'refine', type: 'yesno' }
    ];

    // --- Translations (Merged & Standardized) ---
    const translations = {
        en: {
            title: "👋 What do you wanna generate?",
            next: "Next", upload: "Upload File", yes: "Yes", no: "No", saveBtn: "Save",
            regenerateBtn: "🔍 Regenerate with More Detail",
            refineWhich: "🧩 Which part(s) would you like to be more specific?", done: "🎉 Got it! Let me know if you need anything else.",
            question1: "Question 1/5: 👇 Please select a type:",
            question2: "Question 2/5: 💭 Why do you need this? (e.g. for student of grade 2 to have maths class, for parents meeting next week)",
            question3: "Question 3/5: 📎 What do you have on hand? (You can upload files or browse our database)",
            question4: "Question 4/5: ✏️ Add more details: Comment, Grade, Number of Students, Duration, Length",
            question5: "Question 5/5: 🔍 Do you want to make any part more specific?",
            pleaseFill: "Please provide some input or select a file.", noExtractedText: "No extracted text found – please upload a PDF / Word / image first.",
            noTemplateFound: "⚠️ No corresponding template was found to generate content!", atLeastOnePart: "Please select at least one part to refine.", generationFailed: "❌ Generation failed. Please try again.",
            pleaseRefine: "✅ Yes, please refine.", noThanks: "❌ No, that’s enough.", replacedMsg: "🔄 \"{filename}\" replaced.",
            replaceConfirm: "Replace previously selected \"{filename}\"?", infoCollected: "✅ All info collected. Ready to generate!",
            type_lesson: "Lesson Plan", type_materials: "Class Materials (PPT/pictures)", type_report: "Report Card", type_feedback: "Student‑Work Feedback",
            type_bank: "Subject Question Bank / Assignment", type_activity: "Activity Plan / Extracurricular", type_admin: "Admin Helper (PPT / Word)",
            ph_comment: "Comment (optional)", ph_grade: "Grade (optional)", ph_students: "Number of Students", ph_duration: "Duration (e.g., 45 mins)",
            ph_length: "Length (Short / Medium / Long)", pleaseWait: "Please wait for 1 minute…", pleaseWaitVA: "Your Visual Assets is delivering…",
            ph_input: "Type something...", details: "Details", label_comment: "Comment", label_grade: "Grade", label_students: "Number of Students",
            label_duration: "Duration", label_length: "Length", na: "N/A",
            browseFiles: "📁 Browse files from database:", uploadFiles: "Upload Files", browseDatabase: "Browse Database",
            confirmSelection: "Confirm Selection", exportDocx: "Export to .docx",
            exportError: "Failed to generate .docx file. Please try again.",
            exportLibraryMissing: "Export library not found. Please refresh the page."
        },
        zh: {}, "zh-HK": {}
    };
    translations.zh = { ...translations.en,
        title: "👋 你想生成什么？", next: "下一步", upload: "上传文件", yes: "是", no: "否", saveBtn: "保存",
        regenerateBtn: "🔍 重新生成并丰富细节",
        refineWhich: "🧩 你想让哪些部分更具体？", done: "🎉 明白了！如有其他需求请告诉我。",
        question1: "问题 1/5：� 请选择一个类型：", question2: "问题 2/5：💭 你为什么需要这个？（例如：为二年级学生上的数学课，或是下周的家长会）",
        question3: "问题 3/5：📎 你现在手上有什么资料？（你可以上传文件或浏览我们的数据库）",
        question4: "问题 4/5：✏️ 请补充更多信息：注释、年级、学生人数、时长、长度", question5: "问题 5/5：🔍 是否希望某些部分更具体？",
        pleaseFill: "请提供一些输入或选择一个文件。", noExtractedText: "未找到提取的文本 – 请上传 PDF / Word / 图片文件。",
        noTemplateFound: "⚠️ 找不到对应的生成模板！", atLeastOnePart: "请至少选择一个要细化的部分。", generationFailed: "❌ 生成失败。请重试。",
        pleaseRefine: "✅ 是的，请细化。", noThanks: "❌ 不用了。", replacedMsg: "🔄 已替换\"{filename}\"。",
        replaceConfirm: "是否替换之前选择的\"{filename}\"？", infoCollected: "✅ 所有信息已收集，准备生成！",
        type_lesson: "课程教案", type_materials: "课堂素材 (PPT/图片)", type_report: "成绩单", type_feedback: "作品反馈",
        type_bank: "题库 / 作业", type_activity: "活动方案", type_admin: "行政文档 (PPT/Word)",
        ph_comment: "注释（可选）", ph_grade: "年级（可选）", ph_students: "学生人数", ph_duration: "时长（例如 45 分钟）",
        ph_length: "长度（短 / 中 / 长）", pleaseWait: "请等待 1 分钟…", pleaseWaitVA: "您的教材正在送上...",
        ph_input: "请输入内容…", details: "详情", label_comment: "注释", label_grade: "年级", label_students: "学生人数",
        label_duration: "时长", label_length: "长度", na: "未填写",
        browseFiles: "📁 从数据库中选择文件：", uploadFiles: "上传文件", browseDatabase: "浏览数据库",
        confirmSelection: "确认选择", exportDocx: "导出到 .docx",
        exportError: "生成 .docx 文件失败，请重试。",
        exportLibraryMissing: "找不到导出库。请刷新页面。"
    };
    translations["zh-HK"] = { ...translations.en,
        title: "👋 你想要生成什麼？", next: "下一步", upload: "上傳檔案", yes: "是", no: "否", saveBtn: "儲存",
        regenerateBtn: "🔍 重新生成並豐富細節",
        refineWhich: "🧩 你想讓哪些部分更具體？", done: "🎉 明白！如有其他需要請告訴我。",
        question1: "問題 1/5：👇 請選擇一個類型：", question2: "問題 2/5：💭 你為什麼需要這個？（例如：為二年級學生上的數學課，或是下週的家長會）",
        question3: "問題 3/5：📎 你現在手上有什麼資料 (你可以上傳檔案或瀏覽我們的數據庫)",
        question4: "問題 4/5：✏️ 請補充更多細節：註解、年級、學生數量、時間、長度", question5: "問題 5/5：🔍 是否需要更具體的部分？",
        pleaseFill: "請提供一些輸入或選擇一個文件。", noExtractedText: "未找到提取內容 – 請先上傳 PDF / Word / 圖片。",
        noTemplateFound: "⚠️ 找不到對應的生成模板！", atLeastOnePart: "請至少選擇一個需要細化的部分。", generationFailed: "❌ 生成失敗。請再試一次。",
        pleaseRefine: "✅ 是的，請細化。", noThanks: "❌ 不用了。", replacedMsg: "🔄 已替換\"{filename}\"。",
        replaceConfirm: "是否替換之前選擇的\"{filename}\"？", infoCollected: "✅ 所有資訊已收集，準備生成！",
        type_lesson: "課程教案", type_materials: "課堂素材 (PPT/圖片)", type_report: "成績單", type_feedback: "作品回饋",
        type_bank: "題庫 / 作業", type_activity: "活動計畫", type_admin: "行政文件 (PPT/Word)",
        ph_comment: "註解（可選）", ph_grade: "年級（可選）", ph_students: "學生人數", ph_duration: "時長（例如 45 分鐘）",
        ph_length: "長度（短 / 中 / 長）", pleaseWait: "請等待 1 分鐘…", pleaseWaitVA: "您的教材正在送上...",
        ph_input: "請輸入內容…", details: "詳情", label_comment: "註解", label_grade: "年級", label_students: "學生人數",
        label_duration: "時長", label_length: "長度", na: "未填寫",
        browseFiles: "📁 從數據庫中瀏覽檔案：", uploadFiles: "上傳檔案", browseDatabase: "瀏覽數據庫",
        confirmSelection: "確認選取", exportDocx: "導出至 .docx",
        exportError: "生成 .docx 檔案失敗，請再試一次。",
        exportLibraryMissing: "找不到導出庫。請刷新頁面。"
    };

    const templateSections = {
      "Lesson Plan": { en: [ "Lesson Title / Subject Area", "Learning Goals & Measurable Objectives", "Prerequisite Knowledge", "Materials / Resources List", "Step‑by‑step Procedure & Timing", "Assessment / Evidence of Learning", "Differentiation / Accommodations", "Anticipated Difficulties/ Challenges → Solution", "Follow‑up / Reflection box" ], zh: [ "课题 / 学科领域", "学习目标 & 可测量指标", "先备知识", "材料 / 资源清单", "课堂步骤 & 时间分配", "评估方式 / 学习证据", "差异化教学 / 适应策略", "预判难点 / 挑战 → 解决方案", "课后跟进 / 反思" ], "zh-HK": [ "課程標題 / 科目領域", "學習目標 & 可衡量指標", "先備知識", "材料 / 資源清單", "步驟流程 & 時間配置", "評量方式 / 學習證據", "差異化教學 / 調整方案", "預期困難 / 挑戰 → 解決策略", "後續追蹤 / 反思" ] },
      "Class Materials (PPT/pictures)": { en: [ "Presentation Topic / Focus Question", "Expected Audience (Grade or Course)", "Key Points / Slide Outline", "Desired Visual Assets (images, charts, video links)", "Desired Audio Assets (music, sound clips)", "Branding Elements (school logo, colors, fonts)", "Speaker‑note Depth (none / bullet / full script)" ], zh: [ "演示主题 / 关注问题", "目标受众（年级或课程）", "关键要点 / 幻灯片大纲", "视觉素材需求（图片、图表、视频链接）", "音频素材需求（音乐、音效）", "品牌元素（校徽、色彩、字体）", "演讲者备注深度（无 / 要点 / 全脚本）" ], "zh-HK": [ "簡報主題 / 焦點問題", "預期受眾（年級或課程）", "重點 / 投影片大綱", "視覺素材需求（圖片、圖表、影片鏈接）", "音訊素材需求（音樂、音效）", "品牌元素（校徽、色彩、字體）", "講者備註深度（無 / 要點 / 完整稿）" ] },
      "Report Card": { en: [ "Student & Class Identifiers", "Term / Grading Period", "Subject List & Grade Scale", "Attendance Figures", "Behavior /Work‑Habit Ratings", "Other Learning Experience/ Extra-curricular activities", "Award", "Teacher Narrative Comments", "Parent signature flag" ], zh: [ "学生与班级信息", "学期 / 成绩周期", "科目列表与评分标准", "出勤数据", "行为 / 学习习惯评分", "其他学习经历 / 课外活动", "奖励", "教师评语", "家长签名项" ], "zh-HK": [ "學生與班級資訊", "學期 / 成績週期", "科目清單與評分標準", "出勤數據", "行為 / 學習習慣評分", "其他學習經驗 / 課外活動", "獎勵", "教師評語", "家長簽名項" ] },
      "Student-Work Feedback": { en: [ "Student / Assignment ID", "Rubric criteria or \"Glow & Grow\" fields (Strengths, Needs, Next Steps)", "Performance level or score", "Inline examples / Quotes", "Overall Comment", "Next-check-in Date" ], zh: [ "学生 / 作业编号", "评分标准或“优点与改进”字段（优势、需改进、下一步）", "表现等级或分数", "文中示例 / 引语", "整体评语", "下次回顾日期" ], "zh-HK": [ "學生 / 作業編號", "評分標準或「亮點與改進」欄位（優勢、需改善、後續步驟）", "表現等級或分數", "內文示例 / 引語", "整體評論", "下次檢視日期" ] },
      "Subject Question Bank / Assignment": { en: [ "Subject & Topic Tags", "Standard Alignment", "Question Type (MCQ, open, etc.)", "Difficulty Level", "Question Text", "Answer Choices & Correct Answer", "Explanation / Feedback", "Time Limit Per Item", "Category Folder" ], zh: [ "学科与主题标签", "课程标准对齐", "题型（选择题、开放题等）", "难度等级", "题干", "选项与正确答案", "解析 / 反馈", "每题时间限制", "分类文件夹" ], "zh-HK": [ "學科與主題標籤", "課綱對應", "題型（選擇題、開放題等）", "難度等級", "題目內容", "選項與正確答案", "解析 / 回饋", "每題時間限制", "分類資料夾" ] },
      "Activity Plan / Extracurricular": { en: [ "Activity Name & Purpose", "Date(s) / Time block", "Location & Access notes", "Target Group / # Students", "Required materials & Equipment", "Action plan", "Roles & supervision: resources allocation/ responsibilities", "Risk / safety considerations", "Assessment or reflection Method" ], zh: [ "活动名称与目的", "日期 / 时间段", "地点与进入说明", "目标群体 / 学生人数", "所需材料与设备", "行动计划", "职责与监督：资源配置 / 分工", "风险 / 安全考量", "评估或反思方式" ], "zh-HK": [ "活動名稱與目的", "日期 / 時段", "地點與進出說明", "目標對象 / 學生人數", "所需材料與設備", "行動計畫", "職責與監督：資源分配 / 任務分工", "風險 / 安全考量", "評估或反思方式" ] },
      "Admin Helper (PPT / Word)": { en: [ "Document Type (agenda, newsletter, handbook, policy)", "Audience", "Key Sections / Talking Points", "Attachments / Links", "Header-footer Branding", "Distribution Date" ], zh: [ "文档类型（议程、简报、手册、政策等）", "目标读者", "重点部分 / 要点", "附件 / 链接", "页眉页脚品牌标识", "发布日期" ], "zh-HK": [ "文件類型（議程、簡報、手冊、政策等）", "目標讀者", "重點內容 / 討論要點", "附件 / 鏈結", "頁首頁尾品牌標誌", "發布日期" ] }
    };
    
    const topicTemplates = {
      "Lesson Plan": "Please generate a detailed Lesson Plan using the following template:\n• Lesson Title / Subject Area\n• Learning Goals & Measurable Objectives\n• Prerequisite Knowledge\n• Materials / Resources List\n• Step‑by‑step Procedure & Timing\n• Assessment / Evidence of Learning\n• Differentiation / Accommodations\n• Anticipated Difficulties/ Challenges → Solution\n• Follow‑up / Reflection box",
      "Class Materials (PPT/pictures)": "Please generate detailed Class Materials based on this template:\n• Presentation Topic / Focus Question\n• Expected Audience (Grade or Course)\n• Key Points / Slide Outline\n• Desired Visual Assets (images, charts, video links)\n• Desired Audio Assets (music, sound clips)\n• Branding Elements (school logo, colors, fonts)\n• Speaker‑note Depth (none / bullet / full script)\nList each slide and suggest a relevant explanatory image for each to help student comprehension.",
      "Report Card": "Please generate a detailed Report Card using this template:\n• Student & Class Identifiers\n• Term / Grading Period\n• Subject List & Grade Scale\n• Attendance Figures\n• Behavior /Work‑Habit Ratings\n• Other Learning Experience/ Extra-curricular activities\n• Award\n• Teacher Narrative Comments\n• Parent signature flag",
      "Student-Work Feedback": "Please generate detailed Student Work Feedback using this template:\n• Student / Assignment ID\n• Rubric criteria or \"Glow & Grow\" fields (Strengths, Needs, Next Steps)\n• Performance level or score\n• Inline examples / Quotes\n• Overall Comment\n• Next-check-in Date",
      "Subject Question Bank / Assignment": "Please generate a Subject Question Bank / Assignment using this template:\n• Subject & Topic Tags\n• Standard Alignment\n• Question Type (MCQ, open, etc.)\n• Difficulty Level\n• Question Text\n• Answer Choices & Correct Answer\n• Explanation / Feedback\n• Time Limit Per Item\n• Category Folder",
      "Activity Plan / Extracurricular": "Please generate a detailed Activity Plan using this template:\n• Activity Name & Purpose\n• Date(s) / Time block\n• Location & Access notes\n• Target Group / # Students\n• Required materials & Equipment\n• Action plan\n• Roles & supervision: resources allocation/ responsibilities\n• Risk / safety considerations\n• Assessment or reflection Method",
      "Admin Helper (PPT / Word)": "Please generate an Admin Helper document using this template:\n• Document Type (agenda, newsletter, handbook, policy)\n• Audience\n• Key Sections / Talking Points\n• Attachments / Links\n• Header-footer Branding\n• Distribution Date"
    };
  </script>

  <!-- Script Part 2: Application Logic -->
  <script>
    // --- Element References ---
    const chat = document.getElementById('chat');
    const input = document.getElementById('user-input');
    const fileInput = document.getElementById('file-upload');
    const stage3FileInput = document.getElementById('stage-3-file-upload');
    const inputArea = document.getElementById('input-area');

    // --- Utility Functions ---
    const t = (key, vars = {}) => {
        let lang = currentLang.split('-')[0];
        if (!translations[lang]) {
            lang = 'en'; // Fallback to english
        }
        let s = translations[lang]?.[key] || translations.en[key] || key;
        for (const [k, v] of Object.entries(vars)) s = s.replace(`{${k}}`, v);
        return s;
    };

    const trType = (opt) => {
        const key = `type_${opt.toLowerCase().replace(/[^a-z]/g, '_').replace(/_{2,}/g, '_').replace(/_$/, '')}`;
        const mapping = {
            'type_lesson_plan': 'type_lesson',
            'type_class_materials_ppt_pictures_': 'type_materials',
            'type_report_card': 'type_report',
            'type_student_work_feedback': 'type_feedback',
            'type_subject_question_bank_assignment': 'type_bank',
            'type_activity_plan_extracurricular': 'type_activity',
            'type_admin_helper_ppt_word_': 'type_admin'
        };
        return t(mapping[key] || opt);
    };

    // --- UI Update Functions ---
    function updateUIText() {
        document.querySelector('h2.centered-heading').textContent = t('title');
        document.querySelector('.next-button').textContent = t('next');
        document.querySelector('.tooltip-text').textContent = t('upload');
        document.getElementById('user-input').placeholder = t('ph_input');
        
        document.querySelectorAll('[data-stage-index] .bubble').forEach(b => {
            const idx = Number(b.parentElement.dataset.stageIndex);
            const isBot = b.parentElement.classList.contains('bot');
            if (isBot && !isNaN(idx) && idx < stages.length) {
                b.textContent = t(stages[idx].promptKey);
            }
        });

        document.getElementById('question3-title').textContent = t('question3');
        document.getElementById('db-browser-label').textContent = t('browseFiles');
        const [uploadBtn, browseBtn] = document.querySelectorAll('#stage-3-ui .choice-btn');
        if (uploadBtn) uploadBtn.textContent = t('uploadFiles');
        if (browseBtn) browseBtn.textContent = t('browseDatabase');
        refreshStage0UI();
    }

    function refreshStage0UI() {
        const promptMsg = document.querySelector('.message.bot[data-stage-index="0"] .bubble');
        if (promptMsg) promptMsg.textContent = t('question1');
        
        const btnContainer = document.querySelector('.message.bot[data-stage-index="0"] + .message.bot');
        if(btnContainer) {
            btnContainer.querySelectorAll('button[data-opt-key]').forEach(btn => {
                btn.textContent = trType(btn.dataset.optKey);
            });
        }
    }

    // --- Core UI Logic ---
    function appendMessage(content, sender, stageIndex = null, asMarkdown = false) {
      content = content || '';
      const container = document.createElement('div');
      container.className = `message ${sender}`;
      if (stageIndex !== null) container.dataset.stageIndex = stageIndex;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = sender === 'bot' ? '🤖' : '🧑‍🏫';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (asMarkdown) {
        renderMarkdown(bubble, content);
      } else {
        bubble.textContent = content;
      }

      container.append(avatar, bubble);
      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
      return container;
    }

    function renderMarkdown(bubble, md) {
        md = (md || '').trim().replace(/^```(markdown)?\n?/i, '').replace(/```$/, '');
        md = md
            .replace(/" | "/g, '"')
            .replace(/' | '/g, "'")
            .replace(/【/g, '[').replace(/】/g, ']')
            .replace(/＊/g, '*')
            .replace(/^[\s\t]*[•▪◦‣]\s+/gm, '* ')
            .replace(/^[\s\t]*·\s+/gm, '* ')
            .replace(/(^|\n)(\s*[*-]\s+)(Slide|Round|Scenario|Step|Phase|Station)\s+([\dA-Za-z]+:)/g, (_, brk, bullet, kw, rest) => `${brk}${bullet}**${kw} ${rest}**`)
            .replace(/(^|\n)(\s{4,}[*-]\s+)([A-Za-z\u4e00-\u9fa5][^:\n]{1,40}?):/g, (_, brk, bullet, heading) => `${brk}${bullet}**${heading}:**`);
            
        bubble.innerHTML = DOMPurify.sanitize(marked.parse(md));
        bubble.querySelectorAll('a').forEach(a => {
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
        });
    }

    // --- Main Conversational Flow (Stages) ---
    function showStage() {
      if (currentStage >= stages.length) {
        generateContent();
        return;
      }

      const stage = stages[currentStage];
      const promptTxt = t(stage.promptKey);
      
      document.getElementById('stage-3-ui').style.display = 'none';
      inputArea.style.display = 'flex';

      if (stage.key === 'have') {
        appendMessage(promptTxt, 'bot', currentStage);
        document.getElementById('stage-3-ui').style.display = 'block';
        //inputArea.style.display = 'none';
        showUploadSection(); 
        return; 
      }

      if (stage.type === 'dropdown') {
        appendMessage(promptTxt, 'bot', currentStage);
        const container = document.createElement('div');
        container.className = 'message bot';
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = '🤖';
        const btnGroup = document.createElement('div');
        Object.assign(btnGroup.style, { display: 'flex', flexDirection: 'column', gap: '8px', marginLeft: '40px' });

        stage.options.forEach(optConst => {
          const btn = document.createElement('button');
          btn.dataset.optKey = optConst;
          btn.textContent = trType(optConst);
          Object.assign(btn.style, { padding: '10px 16px', border: '1px solid #ccc', borderRadius: '6px', background: 'white', cursor: 'pointer', fontFamily: 'Inter', transition: '0.2s' });
          btn.onclick = () => handleChooseType(btn, optConst);
          btnGroup.appendChild(btn);
        });

        container.append(avatar, btnGroup);
        chat.appendChild(container);
      } else if (stage.type === 'yesno') {
        return;
      } else if (stage.key === 'more') {
        renderMoreForm();
      } else {
        appendMessage(promptTxt, 'bot', currentStage);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function handleUserInput() {
        const stage = stages[currentStage];
        if (!stage || stage.key === 'type' || stage.key === 'have') return;
        const value = input.value.trim();
        if (!value) return;
        
        answers[stage.key] = value;
        appendMessage(value, 'user', currentStage);
        input.value = '';
        
        currentStage++;
        showStage();
    }
    
    function handleChooseType(btn, optConst) {
        const stageKey = 'type';
        const oldChoice = answers[stageKey];
        const newLabel = trType(optConst);

        if (oldChoice && oldChoice !== optConst) {
            if (!confirm(t('replaceConfirm', { filename: oldChoice }))) return;
        }

        pruneMessagesAfterStage(-1);
        currentStage = 0;
        showStage(); 
        
        const newBtnGroup = chat.lastChild;
        const buttons = newBtnGroup.querySelectorAll('button');
        buttons.forEach(b => b.classList.remove('selected'));
        const targetBtn = Array.from(buttons).find(b => b.dataset.optKey === optConst);
        if(targetBtn) targetBtn.classList.add('selected');

        answers[stageKey] = optConst;
        appendMessage(newLabel, 'user', 0);
        
        currentStage = 1;
        showStage();
    }

    function pruneMessagesAfterStage(stageIdx) {
      for (let i = stageIdx + 1; i < stages.length; i++) {
        delete answers[stages[i].key];
      }
      if (stageIdx < 2) answers.have = [];

      const messages = Array.from(document.querySelectorAll('#chat .message'));
      let lastMessageToKeep = null;
      for (let i = messages.length - 1; i >= 0; i--) {
        const el = messages[i];
        const idx = parseInt(el.dataset.stageIndex, 10);
        if (el.matches('h2')) continue;

        if (!isNaN(idx) && idx > stageIdx) {
          el.remove();
        } else if (!isNaN(idx) && idx <= stageIdx && !lastMessageToKeep) {
          lastMessageToKeep = el;
        }
      }

      if (lastMessageToKeep) {
        let nextEl = lastMessageToKeep.nextSibling;
        while(nextEl) {
          const toRemove = nextEl;
          nextEl = nextEl.nextSibling;
          toRemove.remove();
        }
      } else { 
        const heading = chat.querySelector('h2');
        chat.innerHTML = '';
        if(heading) chat.appendChild(heading);
      }

      cleanupRefineUI();
      lastGeneratedForm?.remove();
      lastUserMoreMessage?.remove();
      document.getElementById('stage-3-ui').style.display = 'none';
      inputArea.style.display = 'flex';
    }

    // --- Stage 3: File Input (Upload/Browse) ---
    function showUploadSection() {
        document.querySelectorAll('#stage-3-ui .choice-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelector('#stage-3-ui .choice-btn:first-child').classList.add('selected');
        document.getElementById('upload-section').style.display = 'block';
        document.getElementById('db-browser-container').style.display = 'none';
    }

    function showDatabaseSection() {
        document.querySelectorAll('#stage-3-ui .choice-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelector('#stage-3-ui .choice-btn:last-child').classList.add('selected');
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('db-browser-container').style.display = 'block';
        renderGroupedList(Object.values(regions).flatMap(r => r.books));
    }
    
    function handleStage3FileUpload(fileList) {
        if (!fileList.length) return;
        
        const fileNames = Array.from(fileList).map(f => {
            const fileRecord = { id: crypto.randomUUID(), name: f.name, note: '', text: '', source: 'upload' };
            if (!answers.have) answers.have = [];
            answers.have.push(fileRecord);
            extractAndStore(fileRecord, f);
            return `📎 ${f.name}`;
        }).join('\n');
        
        appendMessage(fileNames, 'user', currentStage);
        stage3FileInput.value = ''; // Reset file input

        document.getElementById('stage-3-ui').style.display = 'none';
        inputArea.style.display = 'flex';
        currentStage++;
        showStage();
    }

    function handleDatabaseFileSelection(fileId, title) {
        const fileEntry = { id: fileId, name: title, source: 'database', url: `https://drive.google.com/file/d/${fileId}/view`, text: `Database file reference: ${title}` };
        if (!answers.have) answers.have = [];
        answers.have.push(fileEntry);

        const fileMessage = `Selected from database: <a href="${fileEntry.url}" class="uploaded-file" target="_blank">📚 ${title}</a>`;
        appendMessage(fileMessage, 'user', currentStage, true);
        
        document.getElementById('stage-3-ui').style.display = 'none';
        inputArea.style.display = 'flex';
        currentStage++;
        showStage();
    }

    // --- Database Browser UI (from local) ---
    function parseGradeOrder(title) {
        const match = title.match(/([一二三四五六])年级([上下])册/);
        if (!match) return 999;
        const gradeMap = { 一: 1, 二: 2, 三: 3, 四: 4, 五: 5, 六: 6 };
        const termMap = { 上: 0, 下: 1 };
        return (gradeMap[match[1]] || 0) * 10 + (termMap[match[2]] || 0);
    }

    function renderGroupedList(bookList) {
        const container = document.getElementById('item-list');
        container.innerHTML = '';
        Object.entries(regions).forEach(([regionKey, regionData]) => {
            const regionTitle = document.createElement('div');
            regionTitle.className = 'region-title collapsed';
            regionTitle.textContent = `📚 ${regionData.name}`;
            
            const regionContent = document.createElement('div');
            regionContent.className = 'region-content';
            regionContent.style.display = 'none';
            
            regionTitle.onclick = () => {
                const isCollapsed = regionContent.style.display === 'none';
                regionContent.style.display = isCollapsed ? 'block' : 'none';
                regionTitle.classList.toggle('collapsed', !isCollapsed);
            };
            container.appendChild(regionTitle);
            container.appendChild(regionContent);

            const groupMap = {};
            regionData.books.forEach(book => {
                if(bookList.includes(book)) { // Only render books from the filtered list
                    const group = book.path || regionData.name;
                    if (!groupMap[group]) groupMap[group] = [];
                    groupMap[group].push(book);
                }
            });

            Object.keys(groupMap).sort().forEach(group => {
                const titleEl = document.createElement('div');
                titleEl.className = 'group-title';
                titleEl.textContent = `📂 ${group}`;
                regionContent.appendChild(titleEl);

                groupMap[group]
                    .sort((a, b) => parseGradeOrder(a.title) - parseGradeOrder(b.title) || a.title.localeCompare(b.title))
                    .forEach(book => {
                        const div = document.createElement('div');
                        div.className = 'book-item';
                        div.textContent = book.title;
                        const fileId = extractFileId(book.drive_url);
                        if(fileId) div.onclick = () => onItemClick(div, fileId, book.title);
                        regionContent.appendChild(div);
                    });
            });
        });
    }

    function extractFileId(driveUrl) {
        const m = (driveUrl || '').match(/\/d\/([^/]+)\//);
        return m ? m[1] : null;
    }

    function onItemClick(divEl, fileId, title) {
        document.querySelectorAll('.book-item').forEach(el => el.classList.remove('selected'));
        divEl.classList.add('selected');
        const pdfPreview = document.getElementById('pdf-preview');
        pdfPreview.style.display = 'block';
        const pdfContainer = document.getElementById('pdf-container');
        pdfContainer.innerHTML = `<p style="padding: 20px;">Loading preview...</p>`;
        pdfContainer.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" style="width:100%; height:100%; border:none;"></iframe>`;
        
        const confirmBtn = document.getElementById('confirm-selection');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = t('confirmSelection');
        newConfirmBtn.onclick = () => handleDatabaseFileSelection(fileId, title);
    }

    // --- Stage 4: More Details Form ---
    function renderMoreForm() {
        lastGeneratedForm?.remove();
        lastUserMoreMessage?.remove();

        const container = appendMessage('', 'bot', currentStage);
        const bubble = container.querySelector('.bubble');
        bubble.innerHTML = ''; 

        const promptText = document.createElement('div');
        promptText.textContent = t('question4');
        promptText.style.marginBottom = '8px';

        const form = document.createElement('div');
        Object.assign(form.style, { display: 'flex', flexDirection: 'column', gap: '8px' });
        
        const inputs = {
            prompt: makeInput(t('ph_comment')),
            grade: makeInput(t('ph_grade')),
            students: makeInput(t('ph_students')),
            duration: makeInput(t('ph_duration')),
            length: makeInput(t('ph_length')),
        };

        Object.values(inputs).forEach(inp => form.appendChild(inp));

        const submitBtn = document.createElement('button');
        submitBtn.textContent = t('saveBtn');
        Object.assign(submitBtn.style, { marginTop: '6px', padding: '6px 12px', background: '#10a37f', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer' });
        submitBtn.onclick = () => {
            const moreData = {
                prompt: inputs.prompt.value.trim(),
                grade: inputs.grade.value.trim(),
                students: inputs.students.value.trim(),
                duration: inputs.duration.value.trim(),
                length: inputs.length.value.trim(),
            };
            
            answers['more'] = moreData;
            const na = t('na');
            const userInfo = `
                📌 ${t('details')}:
                - **${t('label_comment')}**: ${moreData.prompt || na}
                - **${t('label_grade')}**: ${moreData.grade || na}
                - **${t('label_students')}**: ${moreData.students || na}
                - **${t('label_duration')}**: ${moreData.duration || na}
                - **${t('label_length')}**: ${moreData.length || na}
            `.trim();
            
            container.remove(); 
            lastUserMoreMessage = appendMessage(userInfo, 'user', currentStage, true);
            
            currentStage++;
            generateContent();
        };

        form.appendChild(submitBtn);
        bubble.append(promptText, form);
        lastGeneratedForm = container;
        chat.scrollTop = chat.scrollHeight;

        function makeInput(placeholder) {
            const inp = document.createElement('input');
            inp.placeholder = placeholder;
            Object.assign(inp.style, { padding: '6px', border: '1px solid #ccc', borderRadius: '6px', fontFamily: 'Inter' });
            return inp;
        }
    }


    // --- File Extraction ---
    async function* extractTextFromFile(file, options = {}) {
        const name = file.name.toLowerCase();
        if (name.endsWith('.pdf')) {
            yield* extractTextFromPDF(file, options);
        } else if (name.endsWith('.docx')) {
            yield* extractTextFromDocx(file);
        } else if (/\.(png|jpg|jpeg)$/i.test(name)) {
            yield* extractTextFromImage(file, { logger: options.tesseractLogger });
        } else {
            yield `⚠️ Unsupported file type: ${file.name}\n`;
        }
    }

    async function* extractTextFromDocx(file) {
        try {
            const { value } = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
            yield value;
        } catch (error) {
            yield `⚠️ Error extracting from ${file.name}: ${error.message}\n`;
        }
    }

    async function* extractTextFromImage(file, options = {}) {
        try {
            const { data: { text } } = await Tesseract.recognize(file, 'chi_sim+chi_tra+en', { logger: options.logger });
            yield text;
        } catch (error) {
            yield `⚠️ OCR error for ${file.name}: ${error.message}\n`;
        }
    }

    async function* extractTextFromPDF(file, options = {}) {
        let arrayBuffer;
        try {
            arrayBuffer = await file.arrayBuffer();
        } catch (readError) {
            yield `⚠️ Error reading file ${file.name}: ${readError.message}\n`;
            return;
        }
        let anyTextYieldedFromLayer = false;
        try {
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer.slice(0) }).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                if (content.items.length > 0) {
                    const pageText = content.items.map(item => item.str).join(' ');
                    if (pageText.trim()) {
                        yield pageText.trim() + '\n';
                        anyTextYieldedFromLayer = true;
                    }
                }
            }
        } catch (err) { /* OCR fallback will run */ }

        if (!anyTextYieldedFromLayer) {
            try {
                const pdfForOcr = await pdfjsLib.getDocument({ data: arrayBuffer.slice(0) }).promise;
                for (let i = 1; i <= Math.min(pdfForOcr.numPages, 3); i++) { // Limit OCR pages
                    const page = await pdfForOcr.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport }).promise;
                    const { data } = await Tesseract.recognize(canvas, 'chi_sim+chi_tra+en', { logger: options.tesseractLogger });
                    if (data.text) yield data.text.trim() + '\n';
                }
            } catch (ocrErr) {
                yield `⚠️ OCR failed for ${file.name}: ${ocrErr.message}\n`;
            }
        }
    }

    async function extractAndStore(fileRecord, file) {
        const extractionId = Symbol(`extraction-${file.name}`);
        pendingExtractions.add(extractionId);
        try {
            let accumulatedText = '';
            for await (const chunk of extractTextFromFile(file)) {
                accumulatedText += chunk;
            }
            fileRecord.text = accumulatedText.trim() || '(empty or no extractable text)';
        } catch (err) {
            fileRecord.text = `❌ Failed: ${err.message || String(err)}`;
        } finally {
            pendingExtractions.delete(extractionId);
        }
    }

    // --- Content Generation & AI Call ---
    async function callDeepSeek(promptText, onChunkReceived) {
        const postData = { promptText, locale: currentLang };
        let reader;
        let completeContent = '';
        let isCompletedSuccessfully = false;

        return new Promise(async (resolve, reject) => {
            try {
                const response = await fetch('https://backend.canpaniongroup.com/aigc/aio-generation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData),
                });
                if (!response.ok || !response.body) throw new Error(`Server error: ${response.status}`);
                
                reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                const processSseEvents = () => {
                    let eolIndex;
                    while ((eolIndex = buffer.indexOf('\n\n')) >= 0) {
                        const messageBlock = buffer.substring(0, eolIndex);
                        buffer = buffer.substring(eolIndex + 2);
                        try {
                            const lines = messageBlock.split('\n');
                            let eventType = 'message';
                            let eventDataString = '';
                            for (const line of lines) {
                                if (line.startsWith('event:')) eventType = line.substring(6).trim();
                                else if (line.startsWith('data:')) eventDataString += line.substring(5).trim();
                            }
                            const parsedData = JSON.parse(eventDataString);
                            if (eventType === 'message' && parsedData.content) {
                                completeContent += parsedData.content;
                                if (onChunkReceived) onChunkReceived(parsedData.content);
                            } else if (eventType === 'end' && parsedData.status === 'completed') {
                                isCompletedSuccessfully = true;
                                resolve(completeContent);
                                return true;
                            } else if (eventType === 'error') {
                                throw new Error(parsedData.error);
                            }
                        } catch (e) { console.error('Error parsing SSE:', e); }
                    }
                    return false;
                };

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        if (buffer.trim()) processSseEvents();
                        if (!isCompletedSuccessfully) {
                           if (completeContent) resolve(completeContent);
                           else reject(new Error('Stream ended prematurely.'));
                        }
                        break;
                    }
                    buffer += decoder.decode(value, { stream: true });
                    if (processSseEvents()) break;
                }
            } catch (error) {
                reject(error);
            } finally {
                if (reader) reader.cancel().catch(() => {});
            }
        });
    }

    async function generateContent() {
        await Promise.allSettled([...pendingExtractions]);
        
        const uploads = answers['have'] || [];
        const fileTexts = uploads
            .filter(f => f.source === 'upload')
            .map(f => (f.text ?? '').trim().slice(0, 8000))
            .filter(Boolean).join('\n\n---\n\n');
            
        const dbRefs = uploads
            .filter(f => f.source === 'database')
            .map(f => `• ${f.name}`)
            .join('\n');

        const selectedType = answers['type'];
        const basePrompt = topicTemplates[selectedType] || '';
        if (!basePrompt) {
            alert(t('noTemplateFound'));
            return;
        }

        const more = answers['more'] || {};
        const na = t('na');
        const purpose = answers['why'] ? `- **Purpose / Rationale**: ${answers['why']}` : '';
        const extraDetails = `
            Context Information:
            ${purpose}
            - **${t('label_comment')}**: ${more.prompt || na}
            - **${t('label_grade')}**: ${more.grade || na}
            - **${t('label_students')}**: ${more.students || na}
            - **${t('label_duration')}**: ${more.duration || na}
            - **${t('label_length')}**: ${more.length || na}
        `.trim();
        
        const docSection = fileTexts ? `📄 Uploaded Document Content:\n\`\`\`\n${fileTexts}\n\`\`\`` : '';
        const dbSection = dbRefs ? `📚 Referenced Database Files:\n${dbRefs}` : '';
        const fullPrompt = [docSection, dbSection, extraDetails, basePrompt].filter(Boolean).join('\n\n');
        console.log('📝 Prompt sent to AI:\n', fullPrompt);

        const loadingMsg = appendMessage('', 'bot');
        const loadingBubble = loadingMsg.querySelector('.bubble');
        loadingBubble.innerHTML = `<img src="https://cdn.prod.website-files.com/67af0a7f5730375704f96216/682588f940a6776a7f6c138a_boywalkingg.gif" style="height:120px;vertical-align:middle;" alt="loading"><span>${t('pleaseWait')}</span>`;

        try {
            let tempResult = '';
            await callDeepSeek(fullPrompt, (chunk) => {
                tempResult += chunk;
                renderMarkdown(loadingBubble, tempResult);
            });
            fullMarkdown = tempResult;
            
            appendExportButton(fullMarkdown);
            askIfRefineNeeded();
        } catch (err) {
            console.error(err);
            loadingBubble.textContent = t('generationFailed');
        }
    }
    
    let exportCount = 0;
    // MODIFIED: This function now uses the html-docx-js library and its correct syntax.
    function appendExportButton(markdownContent) {
        const exportMsg = appendMessage('', 'bot');
        const exportId = `exportbtn-${exportCount++}`;
        exportMsg.querySelector('.bubble').innerHTML = `<a id="${exportId}" href="#" style="text-decoration: none; color: #10a37f; font-weight: bold;">${t('exportDocx')}</a>`;

        document.getElementById(exportId).onclick = (e) => {
            e.preventDefault();

            if (typeof htmlDocx === 'undefined') {
                alert(t('exportLibraryMissing'));
                return;
            }
            
            try {
                const htmlContent = '<html><head><meta charset="utf-8"></head><body>' + marked.parse(markdownContent) + '</body></html>';
                const docxBlob = htmlDocx.asBlob(htmlContent);
                saveAs(docxBlob, 'generated-plan.docx');
            } catch (error) {
                console.error('Error generating DOCX:', error);
                alert(t('exportError'));
            }
        };
    }
    
    // --- Refinement Logic ---
    function cleanupRefineUI() {
        Object.values(refineState).forEach(node => node?.remove());
        Object.keys(refineState).forEach(k => (refineState[k] = null));
    }
    
    function askIfRefineNeeded() {
        cleanupRefineUI();
        refineState.promptMsg = appendMessage(t('question5'), 'bot');
        const container = appendMessage('', 'bot');
        container.querySelector('.avatar').remove();
        const btnGroup = container.querySelector('.bubble');
        btnGroup.style.background = 'none';
        btnGroup.style.padding = '0';
        btnGroup.style.marginLeft = '40px';
        btnGroup.innerHTML = '';
        
        ['yes', 'no'].forEach(key => {
            const btn = document.createElement('button');
            btn.textContent = t(key === 'yes' ? 'pleaseRefine' : 'noThanks');
            Object.assign(btn.style, { padding: '8px 14px', borderRadius: '6px', background: 'white', border: '1px solid #ccc', cursor: 'pointer', marginRight: '10px' });
            btn.onclick = () => {
                btnGroup.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                refineState.userAnswerMsg?.remove();
                refineState.userAnswerMsg = appendMessage(btn.textContent, 'user');
                
                if (key === 'yes') {
                    refineState.gotItMsg?.remove();
                    askRefineSections();
                } else {
                    refineState.optionsContainer?.remove();
                    refineState.botPromptMsg?.remove();
                    refineState.gotItMsg = appendMessage(t('done'), 'bot');
                }
            };
            btnGroup.appendChild(btn);
        });
        refineState.choiceContainer = container;
    }

    function askRefineSections() {
        refineState.optionsContainer?.remove();
        refineState.botPromptMsg?.remove();
        
        const type = answers['type'];
        const langKey = ['en', 'zh', 'zh-HK'].find(k => k === currentLang.split('-')[0]) || 'en';
        const fields = templateSections[type]?.[langKey];
        if (!fields?.length) return;

        refineState.botPromptMsg = appendMessage(t('refineWhich'), 'bot');
        const wrap = appendMessage('', 'bot');
        wrap.querySelector('.avatar').remove();
        const bubble = wrap.querySelector('.bubble');
        bubble.innerHTML = '';
        bubble.style.background = 'none';
        bubble.style.paddingLeft = '40px';

        const selected = new Set();
        fields.forEach(f => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.marginBottom = '6px';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.onchange = () => cb.checked ? selected.add(f) : selected.delete(f);
            label.append(cb, ` ${f}`);
            bubble.appendChild(label);
        });

        const okBtn = document.createElement('button');
        okBtn.textContent = t('regenerateBtn');
        Object.assign(okBtn.style, { marginTop: '10px', padding: '8px 14px', borderRadius: '6px', background: '#10a37f', color: 'white', border: 'none', cursor: 'pointer' });
        okBtn.onclick = async () => {
            if (!selected.size) {
                alert(t('atLeastOnePart'));
                return;
            }
            const partList = [...selected];
            appendMessage(`${t('pleaseRefine')}\n- ${partList.join('\n- ')}`, 'user', null, true);
            
            const loadingMsg = appendMessage('', 'bot');
            const loadingBubble = loadingMsg.querySelector('.bubble');
            loadingBubble.innerHTML = `<img src="https://cdn.prod.website-files.com/67af0a7f5730375704f96216/682588f940a6776a7f6c138a_boywalkingg.gif" style="height:120px;vertical-align:middle;" alt="loading"><span>${t('pleaseWait')}</span>`;

            const prompt = `You are revising a teacher document.\n### Previous draft (markdown)\n\`\`\`\n${fullMarkdown}\n\`\`\`\n### Task\nRewrite ONLY the following section(s) with richer detail, leaving everything else unchanged:\n${partList.map(p => '- ' + p).join('\n')}\nReturn **only the rewritten sections** in markdown, starting with their original headings. **Do not include triple backticks (\`\`\`) in your response.**`;

            try {
                let refinedContent = '';
                await callDeepSeek(prompt, chunk => {
                    refinedContent += chunk;
                    renderMarkdown(loadingBubble, refinedContent);
                });
                fullMarkdown = mergeSections(fullMarkdown, refinedContent);
                appendExportButton(fullMarkdown);
                askIfRefineNeeded();
            } catch (e) {
                loadingBubble.textContent = t('generationFailed');
            }
        };

        bubble.appendChild(okBtn);
        refineState.optionsContainer = wrap;
    }

    function mergeSections(oldDoc, patchDoc) {
        const blocks = patchDoc.split(/^(#+)\s+/m).slice(1);
        for (let i = 0; i < blocks.length; i += 2) {
            const headingLevel = blocks[i];
            const headingAndBody = blocks[i + 1];
            const heading = headingAndBody.split('\n')[0].trim();
            const body = headingAndBody.substring(heading.length).trim();
            
            const hEsc = escapeRegExp(heading);
            const re = new RegExp(`^${headingLevel}\\s+${hEsc}[\\s\\S]*?(?=\\n${headingLevel}|$)`, 'm');
            
            const newSection = `${headingLevel} ${heading}\n${body}`;
            if (re.test(oldDoc)) {
                oldDoc = oldDoc.replace(re, newSection);
            } else {
                oldDoc += `\n\n${newSection}`;
            }
        }
        return oldDoc;
    }

    // --- Event Listeners ---
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleUserInput();
        }
    });
    
    fileInput.addEventListener('change', () => {
        if(currentStage === 2) {
            handleStage3FileUpload(fileInput.files);
        }
        fileInput.value = '';
    });

    // --- Initialisation ---
    window.addEventListener('DOMContentLoaded', () => {
      currentLang = document.documentElement.lang || 'en';
      updateUIText();
      showStage();
      
      const filterInput = document.getElementById('filter-input');
      filterInput.addEventListener('input', e => {
          const kw = e.target.value.trim().toLowerCase();
          const allBooks = Object.values(regions).flatMap(r => r.books);
          if(!kw) {
            renderGroupedList(allBooks);
            return;
          }
          const filtered = allBooks.filter(b => b.title.toLowerCase().includes(kw) || (b.path && b.path.toLowerCase().includes(kw)));
          renderGroupedList(filtered);
      });
    });
  </script>
</body>
</html>
