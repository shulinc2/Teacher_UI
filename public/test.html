<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“š æ•™ææ•°æ®åº“æµè§ˆå™¨</title>
  <style>
    #item-list {
      height: 500px;
      overflow-y: auto;
      margin-top: 6px;
      border: 1px solid #eee;
      padding: 4px;
    }
    .book-item {
      padding: 6px 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
    }
    .book-item:hover {
      background: #f7f7f7;
    }
    .book-item.selected {
      background: #d2f0ff;
    }
    .group-title {
      margin: 10px 0 4px;
      font-weight: bold;
      background: #f0f0f0;
      padding: 4px 6px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ ä»æ•°æ®åº“ä¸­é€‰æ‹©æ–‡ä»¶</h2>
  <input type="text" id="filter-input" placeholder="ğŸ” æœç´¢â€¦" style="width:100%; padding:4px; margin:6px 0;"/>
  <div id="item-list"></div>

  <!-- ä¸€å®šè¦å…ˆåŠ è½½ books.js -->
  <script src="books.js"></script>

  <script>
    function extractFileId(driveUrl) {
      const m = driveUrl.match(/\/d\/([^/]+)\//);
      return m ? m[1] : '';
    }

    async function onItemClick(divEl, fileId, title) {
      document.querySelectorAll('.book-item').forEach(el => el.classList.remove('selected'));
      divEl.classList.add('selected');
      console.log('âœ… ä½ ç‚¹å‡»äº†ï¼š', title, 'ï¼ŒfileId =', fileId);

      // æ‰“å¼€æ–‡ä»¶åœ¨ Google Drive ä¸­
      const viewerUrl = `https://drive.google.com/file/d/${fileId}/view`;
      window.open(viewerUrl, '_blank');
    }

    function parseGradeOrder(title) {
      const match = title.match(/([ä¸€äºŒä¸‰å››äº”å…­])å¹´çº§([ä¸Šä¸‹])å†Œ/);
      if (!match) return 999;
      const gradeMap = { ä¸€: 1, äºŒ: 2, ä¸‰: 3, å››: 4, äº”: 5, å…­: 6 };
      const termMap = { ä¸Š: 0, ä¸‹: 1 };
      const grade = gradeMap[match[1]] || 0;
      const term = termMap[match[2]] || 0;
      return grade * 10 + term;
    }

    function renderGroupedList(bookList) {
      const container = document.getElementById('item-list');
      container.innerHTML = '';

      const groupMap = {};
      bookList.forEach(book => {
        const group = book.path || 'æœªåˆ†ç±»';
        if (!groupMap[group]) groupMap[group] = [];
        groupMap[group].push(book);
      });

      const sortedGroupNames = Object.keys(groupMap).sort();

      sortedGroupNames.forEach(groupName => {
        const groupTitle = document.createElement('div');
        groupTitle.className = 'group-title';
        groupTitle.textContent = `ğŸ“‚ ${groupName}`;
        container.appendChild(groupTitle);

        const sortedBooks = groupMap[groupName].sort((a, b) => {
          return parseGradeOrder(a.title) - parseGradeOrder(b.title) ||
                 a.title.localeCompare(b.title);
        });

        sortedBooks.forEach(book => {
          const div = document.createElement('div');
          div.className = 'book-item';
          div.textContent = book.title;
          const fileId = extractFileId(book.drive_url);
          div.dataset.fileId = fileId;

          div.addEventListener('click', () => onItemClick(div, fileId, book.title));
          container.appendChild(div);
        });
      });
    }

    document.getElementById('filter-input').addEventListener('input', (e) => {
      const kw = e.target.value.trim().toLowerCase();
      const filtered = books.filter(b =>
        b.title.toLowerCase().includes(kw) || b.path.toLowerCase().includes(kw)
      );
      renderGroupedList(filtered);
    });

    window.addEventListener('DOMContentLoaded', () => {
      renderGroupedList(books);
    });
  </script>
</body>
</html>


